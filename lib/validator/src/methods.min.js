"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _xeUtils=_interopRequireDefault(require("xe-utils/methods/xe-utils")),_tools=require("../../tools");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _defineProperty(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function _createClass(e,t,r){return t&&_defineProperties(e.prototype,t),r&&_defineProperties(e,r),e}var Rule=function(){function t(e){_classCallCheck(this,t),Object.assign(this,{$options:e,required:e.required,min:e.min,max:e.min,type:e.type,pattern:e.pattern,validator:e.validator,trigger:e.trigger,maxWidth:e.maxWidth})}return _createClass(t,[{key:"message",get:function(){return _tools.UtilTools.getFuncText(this.$options.message)}}]),t}(),_default={_fullValidate:function(e,t){return this.beginValidate(e,t,!0)},_validate:function(e,t){return this.beginValidate(e,t)},handleValidError:function(e){var t=this;this.handleActived(e,{type:"valid-error",trigger:"call"}).then(function(){return t.showValidTooltip(e)})},beginValidate:function(e,n,o){var s=this,u={},a=!0,t=this.editRules,r=this.tableData,i=this.tableFullData,c=this.scrollYLoad,l=c?i:r;e&&(_xeUtils.default.isFunction(e)?n=e:l=_xeUtils.default.isArray(e)?e:[e]);var f=[];if(this.lastCallTime=Date.now(),this.clearValidate(),t){var d=this.getColumns();return l.forEach(function(a){var e=[];d.forEach(function(l,n){_xeUtils.default.has(t,l.property)&&e.push(new Promise(function(r,i){s.validCellRules("all",a,l).then(r).catch(function(e){var t={rule:e.rule,rules:e.rules,rowIndex:s.getRowIndex(a),row:a,columnIndex:n,column:l,$table:s};return o?(u[l.property]||(u[l.property]=[]),u[l.property].push(t),r()):i(t)})}))}),f.push(Promise.all(e))}),Promise.all(f).then(function(){var e=Object.keys(u);if(e.length)return Promise.reject(u[e[0]][0]);n&&n(a)}).catch(function(i){var l=o?u:_defineProperty({},i.column.property,i);return new Promise(function(e,t){var r=function(){i.cell=_tools.DomTools.getCell(s,i),s.handleValidError(i),n?e(n(a=!1,l)):t(l)};c?s.scrollToRow(i.row,!0).then(r):r()})})}return n&&n(a),Promise.resolve(!0)},hasCellRules:function(t,e,r){var i=this.editRules,l=r.property;if(l&&i){var n=_xeUtils.default.get(i,l);return n&&n.find(function(e){return"all"===t||!e.trigger||t===e.trigger})}return!1},validCellRules:function(o,s,u,e){var c=this,t=this.editRules,r=u.property,f=[],i=[];if(r&&t){var d=_xeUtils.default.get(t,r),h=_xeUtils.default.isUndefined(e)?_xeUtils.default.get(s,r):e;d&&d.forEach(function(a){i.push(new Promise(function(r){var e=!0===a.required;if("all"!==o&&a.trigger&&o!==a.trigger)r();else if(_xeUtils.default.isFunction(a.validator))a.validator(a,h,function(e){if(_xeUtils.default.isError(e)){var t={type:"custom",trigger:a.trigger,message:e.message,rule:new Rule(a)};f.push(new Rule(t))}return r()},{rules:d,row:s,column:u,rowIndex:c.getRowIndex(s),columnIndex:c.getColumnIndex(u)});else{var t,i=h,l="number"===a.type,n=null==h||""===h;l?i=_xeUtils.default.toNumber(h):t=_xeUtils.default.getSize(i),e&&n?f.push(new Rule(a)):(l&&isNaN(h)||_xeUtils.default.isRegExp(a.pattern)&&!a.pattern.test(h)||_xeUtils.default.isNumber(a.min)&&(l?i<a.min:t<a.min)||_xeUtils.default.isNumber(a.max)&&(l?i>a.max:t>a.max))&&f.push(new Rule(a)),r()}}))})}return Promise.all(i).then(function(){if(f.length){var e={rules:f,rule:f[0]};return Promise.reject(e)}})},_clearValidate:function(){var e=this.$refs.validTip;return Object.assign(this.validStore,{visible:!1,row:null,column:null,content:"",rule:null}),e&&e.visible&&e.close(),this.$nextTick()},triggerValidate:function(i){var l=this,e=this.editConfig,t=this.editStore,r=this.editRules,n=this.validStore,a=t.actived;if(a.row&&r){var o=a.args,s=o.row,u=o.column,c=o.cell;if(this.hasCellRules(i,s,u))return this.validCellRules(i,s,u).then(function(){"row"===e.mode&&n.visible&&n.row===s&&n.column===u&&l.clearValidate()}).catch(function(e){var t=e.rule;if(t.trigger&&i!==t.trigger)return Promise.resolve();var r={rule:t,row:s,column:u,cell:c};return l.showValidTooltip(r),Promise.reject(r)})}return Promise.resolve()},showValidTooltip:function(e){var t=this,r=this.$refs,i=this.height,l=this.tableData,n=this.validOpts,a=e.rule,o=e.row,s=e.column,u=e.cell,c=r.validTip,f=a.message;this.$nextTick(function(){Object.assign(t.validStore,{row:o,column:s,rule:a,content:f,visible:!0}),c&&("tooltip"===n.message||"default"===n.message&&!i&&l.length<2)&&c.toVisible(u,f),_tools.UtilTools.emitEvent(t,"valid-error",[e])})}};exports.default=_default;