"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _xeUtils=_interopRequireDefault(require("xe-utils/methods/xe-utils")),_vXETable=require("../../v-x-e-table"),_tools=require("../../tools");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}var browse=_tools.DomTools.browse,_default={_insert:function(e){return this.insertAt(e)},_insertAt:function(e,t){var r=this,o=this.afterFullData,i=this.editStore,l=this.scrollYLoad,n=this.tableFullData;if(this.treeConfig)throw new Error(_tools.UtilTools.error("vxe.error.treeInsert"));_xeUtils.default.isArray(e)||(e=[e]);var s=o,a=e.map(function(e){return r.defineField(Object.assign({},e))});if(t)if(-1===t)s.push.apply(s,a),n.push.apply(n,a);else{var c=s.indexOf(t);if(-1===c)throw new Error(_tools.UtilTools.error("vxe.error.unableInsert"));s.splice.apply(s,[c,0].concat(a)),n.splice.apply(n,[n.indexOf(t),0].concat(a))}else s.unshift.apply(s,a),n.unshift.apply(n,a);return[].unshift.apply(i.insertList,a),this.handleTableData(),this.updateCache(),this.checkSelectionStatus(),l&&this.updateScrollYSpace(),this.$nextTick().then(function(){return r.recalculate(),{row:a.length?a[a.length-1]:null,rows:a}})},_remove:function(t){var e=this,r=this.afterFullData,o=this.tableFullData,i=this.editStore,l=this.treeConfig,n=this.selectConfig,s=void 0===n?{}:n,a=this.selection,c=this.hasRowInsert,u=this.scrollYLoad,d=i.removeList,h=i.insertList,f=s.checkField,v=[],m=r;if(l)throw new Error(_tools.UtilTools.error("vxe.error.treeRemove"));return t?_xeUtils.default.isArray(t)||(t=[t]):t=o,t.forEach(function(e){c(e)||d.push(e)}),f||_xeUtils.default.remove(a,function(e){return-1<t.indexOf(e)}),o===t?(t=o.slice(0),o.length=0,m.length=0):(v=_xeUtils.default.remove(o,function(e){return-1<t.indexOf(e)}),_xeUtils.default.remove(m,function(e){return-1<t.indexOf(e)})),_xeUtils.default.remove(h,function(e){return-1<t.indexOf(e)}),this.handleTableData(),this.updateCache(),this.checkSelectionStatus(),u&&this.updateScrollYSpace(),this.$nextTick().then(function(){return e.recalculate(),{row:t&&t.length?t[t.length-1]:null,rows:v}})},_removeSelecteds:function(){var t=this;return this.remove(this.getSelectRecords()).then(function(e){return t.clearSelection(),e})},_revert:function(){return _tools.UtilTools.warn("vxe.error.delRevert"),this.revertData.apply(this,arguments)},_revertData:function(e,o){var i=this.tableSourceData,l=this.getRowIndex;return arguments.length?(e&&!_xeUtils.default.isArray(e)&&(e=[e]),e.forEach(function(e){var t=l(e),r=i[t];r&&e&&(o?_xeUtils.default.set(e,o,_xeUtils.default.get(r,o)):_xeUtils.default.destructuring(e,r))}),this.$nextTick()):this.reloadData(i)},_getRecordset:function(){return{insertRecords:this.getInsertRecords(),removeRecords:this.getRemoveRecords(),updateRecords:this.getUpdateRecords()}},_getInsertRecords:function(){return this.editStore.insertList},_getRemoveRecords:function(){return this.editStore.removeList},_getUpdateRecords:function(){var e=this.tableFullData,t=this.hasRowChange,r=this.treeConfig;return r?_xeUtils.default.filterTree(e,function(e){return t(e)},r):e.filter(function(e){return t(e)})},handleActived:function(e,t){var r=this,o=this.editStore,i=this.editConfig,l=this.tableColumn,n=i.activeMethod,s=o.actived,a=e.row,c=e.column,u=e.cell,d=c.model;if(c.editRender&&u)if(s.row!==a||"cell"===i.mode&&s.column!==c){var h="edit-disabled";n&&!n(e)||((this.keyboardConfig||this.mouseConfig)&&(this.clearCopyed(t),this.clearChecked(),this.clearSelected(t)),this.clostTooltip(),this.clearActived(t),h="edit-actived",c.renderHeight=u.offsetHeight,s.args=e,s.row=a,s.column=c,"row"===i.mode?l.forEach(function(e){e.editRender&&(e.model.value=_tools.UtilTools.getCellValue(a,e),e.model.update=!1)}):(d.value=_tools.UtilTools.getCellValue(a,c),d.update=!1),this.$nextTick(function(){r.handleFocus(e,t)})),_tools.UtilTools.emitEvent(this,h,[e,t])}else{var f=s.column;if(f!==c){var v=f.model;v.update&&_tools.UtilTools.setCellValue(a,f,v.value),this.clearValidate()}c.renderHeight=u.offsetHeight,s.args=e,s.column=c,setTimeout(function(){r.handleFocus(e,t)})}return this.$nextTick()},_clearActived:function(e){var t=this.editStore.actived,r=t.args,o=t.row,i=t.column;if(o||i){var l=i.model;l.update&&(_tools.UtilTools.setCellValue(o,i,l.value),l.update=!1,l.value=null,this.updateFooter()),_tools.UtilTools.emitEvent(this,"edit-closed",[r,e])}return t.args=null,t.row=null,t.column=null,this.clearValidate().then(this.recalculate)},_getActiveRow:function(){var e=this.$el,t=this.editStore,r=this.tableData,o=t.actived,i=o.args,l=o.row;return i&&-1<r.indexOf(l)&&e.querySelectorAll(".vxe-body--column.col--actived").length?Object.assign({},i):null},_hasActiveRow:function(e){return this.editStore.actived.row===e},handleFocus:function(e,t){var r=e.column,o=e.cell,i=r.editRender;if(i){var l,n=_vXETable.Renderer.get(i.name),s=i.autofocus,a=i.autoselect;if(s&&(l=o.querySelector(s)),!l&&n&&n.autofocus&&(l=o.querySelector(n.autofocus)),l&&(l[a?"select":"focus"](),browse.msie)){var c=l.createTextRange();c.collapse(!1),c.select()}}},_setActiveRow:function(e){return this.setActiveCell(e,this.visibleColumn.find(function(e){return e.editRender}).property)},_setActiveCell:function(r,o){var i=this;return this.scrollToRow(r,!0).then(function(){if(r&&o){var e=i.visibleColumn.find(function(e){return e.property===o});if(e&&e.editRender){var t=_tools.DomTools.getCell(i,{row:r,column:e});t&&(i.handleActived({row:r,rowIndex:i.getRowIndex(r),column:e,columnIndex:i.getColumnIndex(e),cell:t,$table:i}),i.lastCallTime=Date.now())}}return i.$nextTick()})},_setSelectCell:function(e,t){var r=this.tableData,o=this.editConfig,i=this.visibleColumn;if(e&&t&&"manual"!==o.trigger){var l=i.find(function(e){return e.property===t}),n=r.indexOf(e);if(-1<n&&l){var s=_tools.DomTools.getCell(this,{row:e,rowIndex:n,column:l}),a={row:e,rowIndex:n,column:l,columnIndex:i.indexOf(l),cell:s};this.handleSelected(a,{})}}return this.$nextTick()},handleSelected:function(i,l){var n=this,e=this.mouseConfig,s=void 0===e?{}:e,a=this.editConfig,t=this.editStore,c=this.elemStore,u=t.actived,d=t.selected,h=i.row,f=i.column,v=i.cell;return function(){if((d.row!==h||d.column!==f)&&(u.row!==h||"cell"===a.mode&&u.column!==f)){if((n.keyboardConfig||n.mouseConfig)&&(n.clearChecked(l),n.clearIndexChecked(),n.clearHeaderChecked(),n.clearSelected(l)),n.clearActived(l),d.args=i,d.row=h,d.column=f,s.selected){var e=c["main-body-list"],t=_tools.UtilTools.getRowid(n,h),r=e.querySelector('[data-rowid="'.concat(t,'"]')).querySelector(".".concat(f.id));_tools.DomTools.addClass(r,"col--selected")}if(s.checked){var o=c["main-header-list"];n.handleChecked([[v]]),o&&n.handleHeaderChecked([[o.querySelector(".".concat(f.id))]]),n.handleIndexChecked([[v.parentNode.querySelector(".col--index")]])}}return n.$nextTick()}()}};exports.default=_default;