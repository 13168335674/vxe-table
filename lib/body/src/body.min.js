"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var scrollProcessTimeout,_xeUtils=_interopRequireDefault(require("xe-utils/methods/xe-utils")),_conf=_interopRequireDefault(require("../../conf")),_tools=require("../../tools");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _defineProperty(e,l,o){return l in e?Object.defineProperty(e,l,{value:o,enumerable:!0,configurable:!0,writable:!0}):e[l]=o,e}function isOperateMouse(e){return e._isResize||e.lastScrollTime&&Date.now()<e.lastScrollTime+e.optimizeOpts.delayHover}function countTreeExpand(e,l){var o=l.$table,t=e[o.treeOpts.children],r=1;if(o.isTreeExpandByRow(e))for(var n=0;n<t.length;n++)r+=countTreeExpand(t[n],l);return r}function getOffsetSize(e){switch(e.vSize){case"mini":return 3;case"small":return 2;case"medium":return 1}return 0}function calcTreeLine(e,l){var o=e.$table,t=e.$rowIndex,r=1;return t&&(r=countTreeExpand(l[t-1],e)),o.rowHeight*r-(t?1:12-getOffsetSize(o))}function renderBorder(e,l){return e("div",{class:"vxe-table-".concat(l,"ed-borders"),ref:"".concat(l,"Borders")},[e("span",{class:"vxe-table-border-top",ref:"".concat(l,"Top")}),e("span",{class:"vxe-table-border-right",ref:"".concat(l,"Right")}),e("span",{class:"vxe-table-border-bottom",ref:"".concat(l,"Bottom")}),e("span",{class:"vxe-table-border-left",ref:"".concat(l,"Left")})])}function renderColumn(e,l,o,t,r,n,i,s,c,d,a,u,f,p,x){var v,w,y=o._e,g=o.$listeners,m=o.tableData,b=o.height,h=o.columnKey,$=o.overflowX,T=o.scrollXLoad,_=o.scrollYLoad,I=o.highlightCurrentRow,S=o.showOverflow,C=o.align,L=o.cellClassName,k=o.cellStyle,q=o.spanMethod,E=o.radioConfig,O=void 0===E?{}:E,B=o.expandConfig,R=void 0===B?{}:B,P=o.treeOpts,U=o.mouseConfig,H=void 0===U?{}:U,D=o.editConfig,M=o.editRules,z=o.validOpts,N=o.editStore,X=o.validStore,Y=u.editRender,A=u.align,F=u.showOverflow,j=u.className,K=u.treeNode,W=N.actived,G=i?u.fixed!==i:u.fixed&&$,V=_xeUtils.default.isUndefined(F)||_xeUtils.default.isNull(F)?S:F,J="ellipsis"===V,Q="title"===V,Z=!0===V||"tooltip"===V,ee=Q||Z||J,le={},oe=A||C,te=X.row===c&&X.column===u,re=M&&("default"===z.message?b||1<m.length:"inline"===z.message),ne={"data-colid":u.id},ie=Y&&D&&"dblclick"===D.trigger,se={$table:o,$seq:t,seq:r,rowid:n,row:c,rowIndex:d,$rowIndex:a,column:u,columnIndex:f,$columnIndex:p,fixed:i,isHidden:G,level:s,data:m,items:x},ce=o.checkboxConfig||o.selectConfig||{};if(!T&&!_||ee||(J=ee=!0),(Q||Z||g["cell-mouseenter"])&&(le.mouseenter=function(e){if(!isOperateMouse(o)){var l={$table:o,$seq:t,seq:r,rowid:n,row:c,rowIndex:d,$rowIndex:a,column:u,columnIndex:f,$columnIndex:p,fixed:i,isHidden:G,level:s,cell:e.currentTarget};Q?_tools.DomTools.updateCellTitle(e):Z&&o.triggerTooltipEvent(e,l),_tools.UtilTools.emitEvent(o,"cell-mouseenter",[l,e])}}),(Z||g["cell-mouseleave"])&&(le.mouseleave=function(e){isOperateMouse(o)||(Z&&o.handleTargetLeaveEvent(e),_tools.UtilTools.emitEvent(o,"cell-mouseleave",[{$table:o,$seq:t,seq:r,rowid:n,row:c,rowIndex:d,$rowIndex:a,column:u,columnIndex:f,$columnIndex:p,fixed:i,isHidden:G,level:s,cell:e.currentTarget},e]))}),(H.checked||H.selected)&&(le.mousedown=function(e){o.triggerCellMousedownEvent(e,{$table:o,$seq:t,seq:r,rowid:n,row:c,rowIndex:d,$rowIndex:a,column:u,columnIndex:f,$columnIndex:p,fixed:i,isHidden:G,level:s,cell:e.currentTarget})}),(I||g["cell-click"]||H.checked||Y&&D||"row"===R.trigger||"cell"===R.trigger||"row"===O.trigger||"radio"===u.type&&"cell"===O.trigger||"row"===ce.trigger||("checkbox"===u.type||"selection"===u.type)&&"cell"===ce.trigger||"row"===P.trigger||u.treeNode&&"cell"===P.trigger)&&(le.click=function(e){o.triggerCellClickEvent(e,{$table:o,$seq:t,seq:r,rowid:n,row:c,rowIndex:d,$rowIndex:a,column:u,columnIndex:f,$columnIndex:p,fixed:i,isHidden:G,level:s,cell:e.currentTarget})}),(ie||g["cell-dblclick"])&&(le.dblclick=function(e){o.triggerCellDBLClickEvent(e,{$table:o,$seq:t,seq:r,row:c,rowIndex:d,$rowIndex:a,column:u,columnIndex:f,$columnIndex:p,fixed:i,isHidden:G,level:s,cell:e.currentTarget})}),q){var de=q(se)||{},ae=de.rowspan,ue=void 0===ae?1:ae,fe=de.colspan,pe=void 0===fe?1:fe;if(!ue||!pe)return null;ne.rowspan=ue,ne.colspan=pe}return!G&&D&&D.showStatus&&(w=o.isUpdateByRow(c,u.property)),e("td",{class:["vxe-body--column",u.id,(v={},_defineProperty(v,"col--".concat(oe),oe),_defineProperty(v,"col--".concat(u.type),u.type),_defineProperty(v,"col--tree-node",K),_defineProperty(v,"col--edit",Y),_defineProperty(v,"col--ellipsis",ee),_defineProperty(v,"edit--visible",Y&&"visible"===Y.type),_defineProperty(v,"fixed--hidden",G),_defineProperty(v,"col--dirty",w),_defineProperty(v,"col--actived",D&&Y&&W.row===c&&(W.column===u||"row"===D.mode)),_defineProperty(v,"col--valid-error",te),v),_tools.UtilTools.getClass(j,se),_tools.UtilTools.getClass(L,se)],key:h?u.id:f,attrs:ne,style:k?_xeUtils.default.isFunction(k)?k(se):k:null,on:le},S&&G?[]:renderLine(e,l,o,s,x,se).concat([e("div",{class:["vxe-cell",{"c--title":Q,"c--tooltip":Z,"c--ellipsis":J}],attrs:{title:Q?_tools.UtilTools.getCellLabel(c,u,se):null}},u.renderCell(e,se)),re?te?e("div",{class:"vxe-cell--valid",style:X.rule&&X.rule.width?{width:"".concat(X.rule.width,"px")}:null},[e("span",{class:"vxe-cell--valid-msg"},X.content)]):y():null]))}function renderLine(e,l,o,t,r,n){var i=n.column,s=o.treeOpts,c=o.treeConfig;return i.slots&&i.slots.line?i.slots.line.call(o,n,e):i.treeNode&&c&&s.line?[e("div",{class:"vxe-tree--line-wrapper"},[e("div",{class:"vxe-tree--line",style:{height:"".concat(calcTreeLine(n,r),"px"),left:"".concat(t*s.indent+(t?2-getOffsetSize(o):0)+16,"px")}})])]:[]}function renderRows(u,f,p,x,v,w,y,g){var m=p.stripe,b=p.rowKey,h=p.highlightHoverRow,$=p.rowClassName,T=p.rowStyle,_=p.treeConfig,I=p.treeOpts,S=p.treeExpandeds,C=p.scrollYLoad,L=p.scrollYStore,k=p.editStore,q=p.rowExpandeds,E=p.getColumnIndex,O=[];return y.forEach(function(t,r){var e,l={},n=r,i=n+1;C&&(i+=L.startIndex),n=p.getRowIndex(t),h&&(l.mouseenter=function(e){isOperateMouse(p)||p.triggerHoverEvent(e,{row:t,rowIndex:n})},l.mouseleave=function(e){isOperateMouse(p)||p.clearHoverRow()});var s=_tools.UtilTools.getRowid(p,t);if(O.push(u("tr",{class:["vxe-body--row",(e={"row--stripe":m&&0<n&&(n+1)%2==0},_defineProperty(e,"row--level-".concat(v),_),_defineProperty(e,"row--new",-1<k.insertList.indexOf(t)),e),$?_xeUtils.default.isFunction($)?$({$table:p,$seq:x,seq:i,rowid:s,fixedType:w,rowLevel:v,row:t,rowIndex:n,$rowIndex:r}):$:""],attrs:{"data-rowid":s},style:T?_xeUtils.default.isFunction(T)?T({$table:p,$seq:x,seq:i,rowid:s,fixedType:w,rowLevel:v,row:t,rowIndex:n,$rowIndex:r}):T:null,key:b||_?s:r,on:l},g.map(function(e,l){var o=E(e);return renderColumn(u,f,p,x,i,s,w,v,t,n,r,e,o,l,y)}))),q.length&&-1<q.indexOf(t)){var o,c=_xeUtils.default.find(g,function(e){return"expand"===e.type}),d=E(c);_&&(o={paddingLeft:"".concat(v*I.indent+30,"px")}),c&&O.push(u("tr",{class:"vxe-body--expanded-row",key:"expand_".concat(s),style:T?_xeUtils.default.isFunction(T)?T({$table:p,$seq:x,seq:i,rowid:s,fixedType:w,rowLevel:v,row:t,rowIndex:n,$rowIndex:r,isExpanded:!0}):T:null,on:l},[u("td",{class:"vxe-body--expanded-column",attrs:{colspan:g.length}},[u("div",{class:["vxe-body--expanded-cell",{"fixed--hidden":w}],style:o},[c.renderData(u,{$table:p,seq:i,rowid:s,row:t,rowIndex:n,column:c,columnIndex:d,fixed:w,level:v})])])]))}if(_&&S.length){var a=t[I.children];a&&a.length&&-1<S.indexOf(t)&&O.push.apply(O,renderRows(u,f,p,x?"".concat(x,".").concat(i):"".concat(i),v+1,w,a,g))}}),O}function syncBodyScroll(e,l,o){(l||o)&&(l&&(l.onscroll=null,l.scrollTop=e),o&&(o.onscroll=null,o.scrollTop=e),clearTimeout(scrollProcessTimeout),scrollProcessTimeout=setTimeout(function(){l&&(l.onscroll=l._onscroll),o&&(o.onscroll=o._onscroll)},100))}var _default={name:"VxeTableBody",props:{tableData:Array,tableColumn:Array,visibleColumn:Array,collectColumn:Array,fixedColumn:Array,size:String,fixedType:String,isGroup:Boolean},mounted:function(){var e=this.$parent,l=this.$el,o=this.$refs,t=this.fixedType,r=e.elemStore,n="".concat(t||"main","-body-");r["".concat(n,"wrapper")]=l,r["".concat(n,"table")]=o.table,r["".concat(n,"colgroup")]=o.colgroup,r["".concat(n,"list")]=o.tbody,r["".concat(n,"xSpace")]=o.xSpace,r["".concat(n,"ySpace")]=o.ySpace,r["".concat(n,"emptyBlock")]=o.emptyBlock,this.$el.onscroll=this.scrollEvent,this.$el._onscroll=this.scrollEvent},beforeDestroy:function(){this.$el._onscroll=null,this.$el.onscroll=null},render:function(o){var e=this._e,l=this.$parent,t=this.fixedColumn,r=this.fixedType,n=l.$scopedSlots,i=l.tableData,s=l.tableColumn,c=l.showOverflow,d=l.scrollXLoad,a=l.mouseConfig,u=void 0===a?{}:a,f=l.keyboardConfig,p=void 0===f?{}:f;return r&&c?s=t:d&&r&&(s=t),o("div",{class:["vxe-table--body-wrapper",r?"fixed-".concat(r,"--wrapper"):"body--wrapper"]},[r?e():o("div",{class:"vxe-body--x-space",ref:"xSpace"}),o("div",{class:"vxe-body--y-space",ref:"ySpace"}),o("table",{class:"vxe-table--body",attrs:{cellspacing:0,cellpadding:0,border:0},ref:"table"},[o("colgroup",{ref:"colgroup"},s.map(function(e,l){return o("col",{attrs:{name:e.id},key:l})})),o("tbody",{ref:"tbody"},renderRows(o,this,l,"",0,r,i,s))]),r||!u.checked&&!p.isCut?null:o("div",{class:"vxe-table--borders"},[u.checked?renderBorder(o,"check"):null,p.isCut?renderBorder(o,"copy"):null]),r?null:o("div",{class:["vxe-table--empty-block",i.length?"":"is--empty"],ref:"emptyBlock"},[o("div",{class:"vxe-table--empty-content"},n.empty?n.empty.call(this,{$table:this},o):_conf.default.i18n("vxe.table.emptyText"))])])},methods:{scrollEvent:function(e){var l=this.$parent,o=this.fixedType,t=l.$refs,r=l.highlightHoverRow,n=l.scrollXLoad,i=l.scrollYLoad,s=l.lastScrollTop,c=l.lastScrollLeft,d=t.tableHeader,a=t.tableBody,u=t.leftBody,f=t.rightBody,p=t.tableFooter,x=d?d.$el:null,v=p?p.$el:null,w=a.$el,y=u?u.$el:null,g=f?f.$el:null,m=w.scrollTop,b=w.scrollLeft,h=b!==c,$=m!==s;l.lastScrollTop=m,l.lastScrollLeft=b,l.lastScrollTime=Date.now(),r&&l.clearHoverRow(),y&&"left"===o?syncBodyScroll(m=y.scrollTop,w,g):g&&"right"===o?syncBodyScroll(m=g.scrollTop,w,y):(h&&(x&&(x.scrollLeft=w.scrollLeft),v&&(v.scrollLeft=w.scrollLeft)),(y||g)&&(l.checkScrolling(),$&&syncBodyScroll(m,y,g))),n&&h&&(l.triggerScrollXEvent(e),x&&b+w.clientWidth>=w.scrollWidth-80&&this.$nextTick(function(){w.scrollLeft!==x.scrollLeft&&(x.scrollLeft=w.scrollLeft)})),i&&$&&l.triggerScrollYEvent(e),_tools.UtilTools.emitEvent(l,"scroll",[{type:"body",fixed:o,scrollTop:m,scrollLeft:b,isX:h,isY:$,$table:l},e])}}};exports.default=_default;