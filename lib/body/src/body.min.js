"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var scrollProcessTimeout,_xeUtils=_interopRequireDefault(require("xe-utils/methods/xe-utils")),_conf=_interopRequireDefault(require("../../conf")),_vXETable=_interopRequireDefault(require("../../v-x-e-table")),_tools=require("../../tools");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _defineProperty(e,l,t){return l in e?Object.defineProperty(e,l,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[l]=t,e}function isOperateMouse(e){return e._isResize||e.lastScrollTime&&Date.now()<e.lastScrollTime+e.optimizeOpts.delayHover}function countTreeExpand(e,l){var t=l.$table,o=e[t.treeOpts.children],r=1;if(t.isTreeExpandByRow(e))for(var n=0;n<o.length;n++)r+=countTreeExpand(o[n],l);return r}function getOffsetSize(e){switch(e.vSize){case"mini":return 3;case"small":return 2;case"medium":return 1}return 0}function calcTreeLine(e,l){var t=e.$table,o=e.$rowIndex,r=1;return o&&(r=countTreeExpand(l[o-1],e)),t.rowHeight*r-(o?1:12-getOffsetSize(t))}function renderBorder(e,l){return e("div",{class:"vxe-table-".concat(l,"ed-borders"),ref:"".concat(l,"Borders")},[e("span",{class:"vxe-table-border-top",ref:"".concat(l,"Top")}),e("span",{class:"vxe-table-border-right",ref:"".concat(l,"Right")}),e("span",{class:"vxe-table-border-bottom",ref:"".concat(l,"Bottom")}),e("span",{class:"vxe-table-border-left",ref:"".concat(l,"Left")})])}function renderColumn(e,l,t,o,r,n,i,s,c,a,d,u,p,f,x,v){var m,y,w=t._e,g=t.$listeners,h=t.tableData,b=t.height,$=t.columnKey,T=t.overflowX,_=t.scrollXLoad,I=t.scrollYLoad,S=t.highlightCurrentRow,C=t.showOverflow,L=t.align,O=t.cellClassName,q=t.cellStyle,k=t.spanMethod,E=t.radioOpts,R=t.checkboxOpts,B=t.expandOpts,P=t.treeOpts,U=t.mouseConfig,H=t.mouseOpts,D=t.editConfig,M=t.editOpts,X=t.editRules,z=t.validOpts,N=t.editStore,Y=t.validStore,A=u.editRender,F=u.align,W=u.showOverflow,j=u.className,K=u.treeNode,G=N.actived,V=U&&H.selected,J=U&&(H.range||H.checked),Q=i?u.fixed!==i:u.fixed&&T,Z=_xeUtils.default.isUndefined(W)||_xeUtils.default.isNull(W)?C:W,ee="ellipsis"===Z,le="title"===Z,te=!0===Z||"tooltip"===Z,oe=le||te||ee,re={},ne=F||L,ie=Y.row===c&&Y.column===u,se=X&&("default"===z.message?b||1<h.length:"inline"===z.message),ce={"data-colid":u.id},ae=A&&D&&"dblclick"===M.trigger,de={$table:t,$seq:o,seq:r,rowid:n,row:c,rowIndex:a,$rowIndex:d,column:u,columnIndex:p,$columnIndex:f,fixed:i,isHidden:Q,level:s,data:h,items:v};if(!_&&!I||oe||(ee=oe=!0),(le||te||g["cell-mouseenter"])&&(re.mouseenter=function(e){if(!isOperateMouse(t)){var l={$table:t,$seq:o,seq:r,rowid:n,row:c,rowIndex:a,$rowIndex:d,column:u,columnIndex:p,$columnIndex:f,fixed:i,isHidden:Q,level:s,cell:e.currentTarget};le?_tools.DomTools.updateCellTitle(e):te&&t.triggerTooltipEvent(e,l),_tools.UtilTools.emitEvent(t,"cell-mouseenter",[l,e])}}),(te||g["cell-mouseleave"])&&(re.mouseleave=function(e){isOperateMouse(t)||(te&&t.handleTargetLeaveEvent(e),_tools.UtilTools.emitEvent(t,"cell-mouseleave",[{$table:t,$seq:o,seq:r,rowid:n,row:c,rowIndex:a,$rowIndex:d,column:u,columnIndex:p,$columnIndex:f,fixed:i,isHidden:Q,level:s,cell:e.currentTarget},e]))}),(R.range||J||V)&&(re.mousedown=function(e){t.triggerCellMousedownEvent(e,{$table:t,$seq:o,seq:r,rowid:n,row:c,rowIndex:a,$rowIndex:d,column:u,columnIndex:p,$columnIndex:f,fixed:i,isHidden:Q,level:s,cell:e.currentTarget})}),(S||g["cell-click"]||J||A&&D||"row"===B.trigger||"cell"===B.trigger||"row"===E.trigger||"radio"===u.type&&"cell"===E.trigger||"row"===R.trigger||("checkbox"===u.type||"selection"===u.type)&&"cell"===R.trigger||"row"===P.trigger||u.treeNode&&"cell"===P.trigger)&&(re.click=function(e){t.triggerCellClickEvent(e,{$table:t,$seq:o,seq:r,rowid:n,row:c,rowIndex:a,$rowIndex:d,column:u,columnIndex:p,$columnIndex:f,fixed:i,isHidden:Q,level:s,cell:e.currentTarget})}),(ae||g["cell-dblclick"])&&(re.dblclick=function(e){t.triggerCellDBLClickEvent(e,{$table:t,$seq:o,seq:r,row:c,rowIndex:a,$rowIndex:d,column:u,columnIndex:p,$columnIndex:f,fixed:i,isHidden:Q,level:s,cell:e.currentTarget})}),k){var ue=k(de)||{},pe=ue.rowspan,fe=void 0===pe?1:pe,xe=ue.colspan,ve=void 0===xe?1:xe;if(!fe||!ve)return null;ce.rowspan=fe,ce.colspan=ve}!Q&&A&&D&&M.showStatus&&(y=t.isUpdateByRow(c,u.property));var me="seq"===u.type||"index"===u.type?"seq":u.type;return e("td",{class:["vxe-body--column",u.id,(m={},_defineProperty(m,"col--".concat(ne),ne),_defineProperty(m,"col--".concat(me),me),_defineProperty(m,"col--last",f===x.length-1),_defineProperty(m,"col--tree-node",K),_defineProperty(m,"col--edit",A),_defineProperty(m,"col--ellipsis",oe),_defineProperty(m,"edit--visible",A&&"visible"===A.type),_defineProperty(m,"fixed--hidden",Q),_defineProperty(m,"col--dirty",y),_defineProperty(m,"col--actived",D&&A&&G.row===c&&(G.column===u||"row"===M.mode)),_defineProperty(m,"col--valid-error",ie),m),_tools.UtilTools.getClass(j,de),_tools.UtilTools.getClass(O,de)],key:$?u.id:p,attrs:ce,style:q?_xeUtils.default.isFunction(q)?q(de):q:null,on:re},C&&Q?[e("div",{class:["vxe-cell",{"c--title":le,"c--tooltip":te,"c--ellipsis":ee}]})]:renderLine(e,l,t,s,v,de).concat([e("div",{class:["vxe-cell",{"c--title":le,"c--tooltip":te,"c--ellipsis":ee}],attrs:{title:le?_tools.UtilTools.getCellLabel(c,u,de):null}},u.renderCell(e,de)),se?ie?e("div",{class:"vxe-cell--valid",style:Y.rule&&Y.rule.maxWidth?{width:"".concat(Y.rule.maxWidth,"px")}:null},[e("span",{class:"vxe-cell--valid-msg"},Y.content)]):w():null]))}function renderLine(e,l,t,o,r,n){var i=n.column,s=t.treeOpts,c=t.treeConfig;return i.slots&&i.slots.line?i.slots.line.call(t,n,e):i.treeNode&&c&&s.line?[e("div",{class:"vxe-tree--line-wrapper"},[e("div",{class:"vxe-tree--line",style:{height:"".concat(calcTreeLine(n,r),"px"),left:"".concat(o*s.indent+(o?2-getOffsetSize(t):0)+16,"px")}})])]:[]}function renderRows(a,d,u,p,f,x,v,m){var y=u.stripe,w=u.rowKey,g=u.highlightHoverRow,h=u.rowClassName,b=u.rowStyle,$=u.treeConfig,T=u.treeOpts,_=u.treeExpandeds,I=u.scrollYLoad,S=u.scrollYStore,C=u.editStore,L=u.rowExpandeds,O=u.radioOpts,q=u.checkboxOpts,k=u.expandColumn,E=u.getColumnIndex,R=[];return v.forEach(function(o,r){var e={},n=r,i=n+1;I&&(i+=S.startIndex),n=u.getRowIndex(o),g&&(e.mouseenter=function(e){isOperateMouse(u)||u.triggerHoverEvent(e,{row:o,rowIndex:n})},e.mouseleave=function(e){isOperateMouse(u)||u.clearHoverRow()});var s=_tools.UtilTools.getRowid(u,o);if(R.push(a("tr",{class:["vxe-body--row",{"row--stripe":y&&0<n&&(n+1)%2==0,"row--new":-1<C.insertList.indexOf(o),"row--radio":O.highlight&&u.selectRow===o,"row--cheched":q.highlight&&u.isCheckedByCheckboxRow(o)},h?_xeUtils.default.isFunction(h)?h({$table:u,$seq:p,seq:i,rowid:s,fixedType:x,rowLevel:f,row:o,rowIndex:n,$rowIndex:r}):h:""],attrs:{"data-rowid":s},style:b?_xeUtils.default.isFunction(b)?b({$table:u,$seq:p,seq:i,rowid:s,fixedType:x,rowLevel:f,row:o,rowIndex:n,$rowIndex:r}):b:null,key:w||$?s:r,on:e},m.map(function(e,l){var t=E(e);return renderColumn(a,d,u,p,i,s,x,f,o,n,r,e,t,l,m,v)}))),L.length&&-1<L.indexOf(o)){var l,t=E(k);$&&(l={paddingLeft:"".concat(f*T.indent+30,"px")}),k&&R.push(a("tr",{class:"vxe-body--expanded-row",key:"expand_".concat(s),style:b?_xeUtils.default.isFunction(b)?b({$table:u,$seq:p,seq:i,rowid:s,fixedType:x,rowLevel:f,row:o,rowIndex:n,$rowIndex:r,isExpanded:!0}):b:null,on:e},[a("td",{class:"vxe-body--expanded-column",attrs:{colspan:m.length}},[a("div",{class:["vxe-body--expanded-cell",{"fixed--hidden":x}],style:l},[k.renderData(a,{$table:u,seq:i,rowid:s,row:o,rowIndex:n,column:k,columnIndex:t,fixed:x,level:f})])])]))}if($&&_.length){var c=o[T.children];c&&c.length&&-1<_.indexOf(o)&&R.push.apply(R,renderRows(a,d,u,p?"".concat(p,".").concat(i):"".concat(i),f+1,x,c,m))}}),R}function syncBodyScroll(e,l,t){(l||t)&&(l&&(l.onscroll=null,l.scrollTop=e),t&&(t.onscroll=null,t.scrollTop=e),clearTimeout(scrollProcessTimeout),scrollProcessTimeout=setTimeout(function(){l&&(l.onscroll=l._onscroll),t&&(t.onscroll=t._onscroll)},100))}var _default={name:"VxeTableBody",props:{tableData:Array,tableColumn:Array,visibleColumn:Array,collectColumn:Array,fixedColumn:Array,size:String,fixedType:String,isGroup:Boolean},mounted:function(){var e=this.$parent,l=this.$el,t=this.$refs,o=this.fixedType,r=e.elemStore,n="".concat(o||"main","-body-");r["".concat(n,"wrapper")]=l,r["".concat(n,"table")]=t.table,r["".concat(n,"colgroup")]=t.colgroup,r["".concat(n,"list")]=t.tbody,r["".concat(n,"xSpace")]=t.xSpace,r["".concat(n,"ySpace")]=t.ySpace,r["".concat(n,"emptyBlock")]=t.emptyBlock,this.$el.onscroll=this.scrollEvent,this.$el._onscroll=this.scrollEvent},beforeDestroy:function(){this.$el._onscroll=null,this.$el.onscroll=null},render:function(t){var e,l=this._e,o=this.$parent,r=this.fixedColumn,n=this.fixedType,i=o.$scopedSlots,s=o.id,c=o.tableData,a=o.tableColumn,d=o.showOverflow,u=o.spanMethod,p=o.scrollXLoad,f=o.mouseConfig,x=o.mouseOpts,v=o.emptyRender,m=o.emptyOpts,y=o.keyboardConfig,w=void 0===y?{}:y,g=f&&(x.range||x.checked);if(u||(n&&d?a=r:p&&n&&(a=r)),i.empty)e=i.empty.call(this,{$table:this},t);else{var h=v?_vXETable.default.renderer.get(m.name):null;e=h&&h.renderEmpty?h.renderEmpty(t,m,{$table:this},{$table:this}):_conf.default.i18n("vxe.table.emptyText")}return t("div",{class:["vxe-table--body-wrapper",n?"fixed-".concat(n,"--wrapper"):"body--wrapper"],attrs:{"data-tid":s}},[n?l():t("div",{class:"vxe-body--x-space",ref:"xSpace"}),t("div",{class:"vxe-body--y-space",ref:"ySpace"}),t("table",{class:"vxe-table--body",attrs:{"data-tid":s,cellspacing:0,cellpadding:0,border:0},ref:"table"},[t("colgroup",{ref:"colgroup"},a.map(function(e,l){return t("col",{attrs:{name:e.id},key:l})})),t("tbody",{ref:"tbody"},renderRows(t,this,o,"",0,n,c,a))]),n||!g&&!w.isCut?null:t("div",{class:"vxe-table--borders"},[g?renderBorder(t,"check"):null,w.isCut?renderBorder(t,"copy"):null]),n?null:t("div",{class:"vxe-table--empty-block",ref:"emptyBlock"},[t("div",{class:"vxe-table--empty-content"},e)])])},methods:{scrollEvent:function(e){var l=this.$parent,t=this.fixedType,o=l.$refs,r=l.highlightHoverRow,n=l.scrollXLoad,i=l.scrollYLoad,s=l.lastScrollTop,c=l.lastScrollLeft,a=o.tableHeader,d=o.tableBody,u=o.leftBody,p=o.rightBody,f=o.tableFooter,x=a?a.$el:null,v=f?f.$el:null,m=d.$el,y=u?u.$el:null,w=p?p.$el:null,g=m.scrollTop,h=m.scrollLeft,b=h!==c,$=g!==s;l.lastScrollTop=g,l.lastScrollLeft=h,l.lastScrollTime=Date.now(),r&&l.clearHoverRow(),y&&"left"===t?syncBodyScroll(g=y.scrollTop,m,w):w&&"right"===t?syncBodyScroll(g=w.scrollTop,m,y):(b&&(x&&(x.scrollLeft=m.scrollLeft),v&&(v.scrollLeft=m.scrollLeft)),(y||w)&&(l.checkScrolling(),$&&syncBodyScroll(g,y,w))),n&&b&&(l.triggerScrollXEvent(e),x&&h+m.clientWidth>=m.scrollWidth-80&&this.$nextTick(function(){m.scrollLeft!==x.scrollLeft&&(x.scrollLeft=m.scrollLeft)})),i&&$&&l.triggerScrollYEvent(e),_tools.UtilTools.emitEvent(l,"scroll",[{type:"body",fixed:t,scrollTop:g,scrollLeft:h,isX:b,isY:$,$table:l},e])}}};exports.default=_default;