"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _xeUtils=_interopRequireDefault(require("xe-utils/methods/xe-utils")),_conf=_interopRequireDefault(require("../../conf")),_vXETable=_interopRequireDefault(require("../../v-x-e-table")),_tools=require("../../tools");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}var printFrame,defaultHtmlStyle="body{margin:0}body *{-webkit-box-sizing:border-box;box-sizing:border-box}.vxe-table{border:0;border-collapse:separate;table-layout:fixed;text-align:left;font-size:14px;border-spacing:0}.vxe-table:not(.b--style-none){border-style:solid;border-width:1px 0 0 1px;border-color:#e8eaec}td,thead tr:last-child th{border-bottom:1px solid #e8eaec}.vxe-table:not(.t--border){border-width:1px}.vxe-table.t--border:not(.b--style-none) td,table.t--border:not(.b--style-none) th{border-right:1px solid #e8eaec}.vxe-table:not(.b--style-none) thead{background-color:#f8f8f9}.vxe-table td>div,.vxe-table th>div{padding:.5em .4em}.col--center{text-align:center}.col--right{text-align:right}.col--ellipsis>div{overflow:hidden;text-overflow:ellipsis;white-space:nowrap;word-break:break-all}.vxe-table--tree-node{text-align:left}.vxe-table--tree-node-wrapper{position:relative}.vxe-table--tree-icon-wrapper{position:absolute;top:50%;width:1em;height:1em;text-align:center;-webkit-transform:translateY(-50%);transform:translateY(-50%);-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;cursor:pointer}.vxe-table--tree-icon{position:absolute;left:0;top:.3em;width:0;height:0;border-style:solid;border-width:.5em;border-top-color:#939599;border-right-color:transparent;border-bottom-color:transparent;border-left-color:transparent}.vxe-table--tree-cell{display:block;padding-left:1.5em}",fileForm=document.createElement("form"),fileInput=document.createElement("input");function createFrame(){var e=document.createElement("iframe");return e.className="vxe-table--print-frame",e}function hasTreeChildren(e,t){var o=e.treeOpts;return t[o.children]&&t[o.children].length}function handleExport(e,t,o,r){var n=getExportData(e,t,r,o),a=n.columns,i=n.datas;return e.preventEvent(null,"event.export",{$table:e,options:t,columns:a,datas:i},function(){return downloadFile(e,t,getContent(e,t,a,i))})}function getContent(e,t,o,r){switch(t.type){case"csv":return toCsv(e,t,o,r);case"txt":return toTxt(e,t,o,r);case"html":return toHtml(e,t,o,r);case"xml":return toXML(e,t,o,r)}return""}function getSeq(e,t,o,r,n){var a=e.seqOpts,i=a.seqMethod||r.indexMethod;return i?i({row:t,rowIndex:o,column:r,columnIndex:n}):(a.startIndex||e.startIndex)+o+1}function getHeaderTitle(e,t){return(e.original?t.property:t.getTitle())||""}function toCsv(o,t,r,e){var n="\ufeff";if(t.isHeader&&(n+=r.map(function(e){return'"'.concat(getHeaderTitle(t,e),'"')}).join(",")+"\n"),e.forEach(function(t,e){n+=r.map(function(e){return'"'.concat(t[e.id],'"')}).join(",")+"\n"}),t.isFooter){var a=o.footerData;(t.footerFilterMethod?a.filter(t.footerFilterMethod):a).forEach(function(t){n+=r.map(function(e){return'"'.concat(t[o.$getColumnIndex(e)]||"",'"')}).join(",")+"\n"})}return n}function toTxt(o,t,r,e){var n="";if(t.isHeader&&(n+=r.map(function(e){return"".concat(getHeaderTitle(t,e))}).join("\t")+"\n"),e.forEach(function(t,e){n+=r.map(function(e){return"".concat(t[e.id])}).join("\t")+"\n"}),t.isFooter){var a=o.footerData;(t.footerFilterMethod?a.filter(t.footerFilterMethod):a).forEach(function(t){n+=r.map(function(e){return"".concat(t[o.$getColumnIndex(e)]||"")}).join(",")+"\n"})}return n}function hasEllipsis(e,t,o,r){var n=t[o],a=_xeUtils.default.isUndefined(n)||_xeUtils.default.isNull(n)?r:n,i="title"===a||(!0===a||"tooltip"===a)||"ellipsis"===a;return!e.scrollXLoad&&!e.scrollYLoad||i||(i=!0),i}function toHtml(i,n,e,t){var o=i.border,r=i.treeConfig,l=i.treeOpts,a=i.headerAlign,s=i.align,c=i.footerAlign,d=i.showOverflow,u=i.showAllOverflow,f=i.showHeaderOverflow,p=i.showHeaderAllOverflow,m=_xeUtils.default.isBoolean(u)?u:d,h=_xeUtils.default.isBoolean(p)?p:f,v=["vxe-table",o?"t--border":"","none"===o?"b--style-none":""],g=["<html>","<head>",'<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no,minimal-ui"><title>'.concat(n.sheetName,"</title>"),"<style>".concat(n.style||defaultHtmlStyle,"</style>"),"</head>","<body>",'<table class="'.concat(v.join(" "),'" border="0" cellspacing="0" cellpadding="0">'),"<colgroup>".concat(e.map(function(e){return'<col style="width:'.concat(e.renderWidth,'px">')}).join(""),"</colgroup>")].join("");if(n.isHeader&&(g+="<thead><tr>".concat(e.map(function(e){var t=e.headerAlign||e.align||a||s,o=hasEllipsis(i,e,"showHeaderOverflow",h)?["col--ellipsis"]:[],r=getHeaderTitle(n,e);return t&&o.push("col--".concat(t)),'<th class="'.concat(o.join(" "),'" title="').concat(r,'"><div style="width: ').concat(e.renderWidth,'px">').concat(r,"</div></th>")}).join(""),"</tr></thead>")),t.length&&(g+="<tbody>",r?t.forEach(function(a){g+="<tr>"+e.map(function(e){var t=e.align||s,o=hasEllipsis(i,e,"showOverflow",m)?["col--ellipsis"]:[],r=a[e.id];if(t&&o.push("col--".concat(t)),e.treeNode){var n="";return a._hasChild&&(n='<i class="vxe-table--tree-icon"></i>'),o.push("vxe-table--tree-node"),'<td class="'.concat(o.join(" "),'" title="').concat(r,'"><div style="width: ').concat(e.renderWidth,'px"><div class="vxe-table--tree-node-wrapper" style="padding-left: ').concat(a._level*l.indent,'px"><div class="vxe-table--tree-icon-wrapper">').concat(n,'</div><div class="vxe-table--tree-cell">').concat(r,"</div></div></div></td>")}return'<td class="'.concat(o.join(" "),'" title="').concat(r,'"><div style="width: ').concat(e.renderWidth,'px">').concat(r,"</div></td>")}).join("")+"</tr>"}):t.forEach(function(n){g+="<tr>"+e.map(function(e){var t=e.align||s,o=hasEllipsis(i,e,"showOverflow",m)?["col--ellipsis"]:[],r=n[e.id];return t&&o.push("col--".concat(t)),'<td class="'.concat(o.join(" "),'" title="').concat(r,'"><div style="width: ').concat(e.renderWidth,'px">').concat(r,"</div></td>")}).join("")+"</tr>"}),g+="</tbody>"),n.isFooter){var x=i.footerData,b=n.footerFilterMethod?x.filter(n.footerFilterMethod):x;b.length&&(g+="<tfoot>",b.forEach(function(n){g+="<tr>".concat(e.map(function(e){var t=e.footerAlign||e.align||c||s,o=hasEllipsis(i,e,"showOverflow",m)?["col--ellipsis"]:[],r=_xeUtils.default.toString(n[i.$getColumnIndex(e)]);return t&&o.push("col--".concat(t)),'<td class="'.concat(o.join(" "),'" title="').concat(r,'"><div style="width: ').concat(e.renderWidth,'px">').concat(r,"</div></td>")}).join(""),"</tr>")}),g+="</tfoot>")}return g+"</table></body></html>"}function toXML(o,t,r,e){var n=['<?xml version="1.0"?>','<?mso-application progid="Excel.Sheet"?>','<Workbook xmlns="urn:schemas-microsoft-com:office:spreadsheet" xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns:ss="urn:schemas-microsoft-com:office:spreadsheet" xmlns:html="http://www.w3.org/TR/REC-html40">','<DocumentProperties xmlns="urn:schemas-microsoft-com:office:office">',"<Version>16.00</Version>","</DocumentProperties>",'<ExcelWorkbook xmlns="urn:schemas-microsoft-com:office:excel">',"<WindowHeight>7920</WindowHeight>","<WindowWidth>21570</WindowWidth>","<WindowTopX>32767</WindowTopX>","<WindowTopY>32767</WindowTopY>","<ProtectStructure>False</ProtectStructure>","<ProtectWindows>False</ProtectWindows>","</ExcelWorkbook>",'<Worksheet ss:Name="'.concat(t.sheetName,'">'),"<Table>",r.map(function(e){return'<Column ss:Width="'.concat(e.renderWidth,'"/>')}).join("")].join("");if(t.isHeader&&(n+="<Row>".concat(r.map(function(e){return'<Cell><Data ss:Type="String">'.concat(getHeaderTitle(t,e),"</Data></Cell>")}).join(""),"</Row>")),e.forEach(function(t,e){n+="<Row>"+r.map(function(e){return'<Cell><Data ss:Type="String">'.concat(t[e.id],"</Data></Cell>")}).join("")+"</Row>"}),t.isFooter){var a=o.footerData;(t.footerFilterMethod?a.filter(t.footerFilterMethod):a).forEach(function(t){n+="<Row>".concat(r.map(function(e){return'<Cell><Data ss:Type="String">'.concat(t[o.$getColumnIndex(e)||""],"</Data></Cell>")}).join(""),"</Row>")})}return"".concat(n,"</Table></Worksheet></Workbook>")}function downloadFile(e,t,o){var r=t.filename,n=t.type,a=t.download,i="".concat(r,".").concat(n);if(window.Blob){var l=new Blob([o],{type:"text/".concat(n)});if(!a)return Promise.resolve({type:n,content:o,blob:l});if(navigator.msSaveBlob)navigator.msSaveBlob(l,i);else{var s=document.createElement("a");s.target="_blank",s.download=i,s.href=URL.createObjectURL(l),document.body.appendChild(s),s.click(),document.body.removeChild(s)}!1!==t.message&&e.$XModal.message({message:_conf.default.i18n("vxe.table.expSuccess"),status:"success"})}else _tools.UtilTools.error("vxe.error.notExp")}function getLabelData(l,s,e){var t=l.treeConfig,o=l.treeOpts,i=l.scrollXLoad,c=l.scrollYLoad;if(t){var d=[];return _xeUtils.default.eachTree(e,function(o,r,e,t,n,a){var i={_level:a.length-1,_hasChild:hasTreeChildren(l,o)};s.forEach(function(e,t){i[e.id]=_xeUtils.default.toString(-1<["seq","index"].indexOf(e.type)?getSeq(l,o,r,e,t):_xeUtils.default.get(o,e.property))}),d.push(Object.assign(i,o))},o),d}return e.map(function(r,n){var a={};return s.forEach(function(e,t){if(i||c)a[e.id]=_xeUtils.default.toString(-1<["seq","index"].indexOf(e.type)?getSeq(l,r,n,e,t):r[e.property]);else{var o=_tools.DomTools.getCell(l,{row:r,column:e});a[e.id]=o?o.innerText.trim():""}}),a})}function getExportData(e,t,o,r){var n=t.columns?t.columns:r,a=t.data||o;return t.columnFilterMethod&&(n=n.filter(t.columnFilterMethod)),t.dataFilterMethod&&(a=a.filter(t.dataFilterMethod)),{columns:n,datas:getLabelData(e,n,a)}}function replaceDoubleQuotation(e){return e.replace(/^"/,"").replace(/"$/,"")}function parseCsv(e,t){var o=t.split("\n"),r=[],n=[];if(o.length){var a=o.slice(1);n=o[0].split(",").map(replaceDoubleQuotation),a.forEach(function(e){if(e){var o={};e.split(",").forEach(function(e,t){n[t]&&(o[n[t]]=replaceDoubleQuotation(e))}),r.push(o)}})}return{fields:n,rows:r}}function parseTxt(e,t){var o=t.split("\n"),r=[],n=[];if(o.length){var a=o.slice(1);n=o[0].split("\t"),a.forEach(function(e){if(e){var o={};e.split("\t").forEach(function(e,t){n[t]&&(o[n[t]]=replaceDoubleQuotation(e))}),r.push(o)}})}return{fields:n,rows:r}}function parseHTML(e,t){var o=getElementsByTagName((new DOMParser).parseFromString(t,"text/html"),"body"),r=[],n=[];if(o.length){var a=getElementsByTagName(o[0],"table");if(a.length){var i=getElementsByTagName(a[0],"thead");if(i.length){_xeUtils.default.arrayEach(getElementsByTagName(i[0],"tr"),function(e){_xeUtils.default.arrayEach(getElementsByTagName(e,"th"),function(e){n.push(e.textContent)})});var l=getElementsByTagName(a[0],"tbody");l.length&&_xeUtils.default.arrayEach(getElementsByTagName(l[0],"tr"),function(e){var o={};_xeUtils.default.arrayEach(getElementsByTagName(e,"td"),function(e,t){n[t]&&(o[n[t]]=e.textContent||"")}),r.push(o)})}}}return{fields:n,rows:r}}function parseXML(e,t){var o=getElementsByTagName((new DOMParser).parseFromString(t,"application/xml"),"Worksheet"),n=[],a=[];if(o.length){var r=getElementsByTagName(o[0],"Table");if(r.length){var i=getElementsByTagName(r[0],"Row");i.length&&(_xeUtils.default.arrayEach(getElementsByTagName(i[0],"Cell"),function(e){a.push(e.textContent)}),_xeUtils.default.arrayEach(i,function(e,t){if(t){var o={},r=getElementsByTagName(e,"Cell");_xeUtils.default.arrayEach(r,function(e,t){a[t]&&(o[a[t]]=e.textContent)}),n.push(o)}}))}}return{fields:a,rows:n}}function getElementsByTagName(e,t){return e.getElementsByTagName(t)}function checkImportData(e,t,o){var r=[];return e.forEach(function(e){var t=e.property;t&&r.push(t)}),r.every(function(e){return-1<t.indexOf(e)})}function handleImport(t,e,o){var r=t.tableFullColumn,n=t._importResolve,a={fields:[],rows:[]};switch(o.type){case"csv":a=parseCsv(r,e);break;case"txt":a=parseTxt(r,e);break;case"html":a=parseHTML(r,e);break;case"xml":a=parseXML(r,e)}var i=a.fields,l=a.rows,s=checkImportData(r,i,l);s?(t.createData(l).then(function(e){"append"===o.mode?t.insertAt(e,-1):t.reloadData(e)}),!1!==o.message&&t.$XModal.message({message:_conf.default.i18n("vxe.table.impSuccess"),status:"success"})):!1!==o.message&&t.$XModal.message({message:_conf.default.i18n("vxe.error.impFields"),status:"error"}),n&&(n(s),t._importResolve=null)}fileForm.className="vxe-table--import-form",fileInput.name="file",fileInput.type="file",fileForm.appendChild(fileInput);var _default={methods:{_exportCsv:function(e){return _tools.UtilTools.warn("vxe.error.delFunc",["exportCsv","exportData"]),this.exportData(e)},_exportData:function(e){var t=this.visibleColumn,o=this.tableFullData,r=Object.assign({filename:"",sheetName:"",original:!1,message:!1,isHeader:!0,isFooter:!0,download:!0,type:"csv",data:null,columns:null,columnFilterMethod:e&&e.columns?null:function(e){return-1<["seq","index"].indexOf(e.type)||e.property},dataFilterMethod:null,footerFilterMethod:null},_conf.default.export,e);if(r.filename||(r.filename=_xeUtils.default.template(_conf.default.i18n(r.original?"vxe.table.expOriginFilename":"vxe.table.expFilename"),[_xeUtils.default.toDateString(Date.now(),"yyyyMMddHHmmss")])),r.sheetName||(r.sheetName=_conf.default.i18n("vxe.table.expSheetName")),-1===_vXETable.default.exportTypes.indexOf(r.type))throw new Error(_tools.UtilTools.getLog("vxe.error.notType",[r.type]));return handleExport(this,r,t,o)},_importByFile:function(t,e){var o=this;if(window.FileReader){var r=_tools.UtilTools.parseFile(t),n=r.type,a=r.filename,i=Object.assign({mode:"covering"},e,{type:n,filename:a});-1<(i.types||_vXETable.default.importTypes).indexOf(n)?this.preventEvent(null,"event.import",{$table:this,file:t,options:i,columns:this.tableFullColumn},function(){var e=new FileReader;e.onerror=function(e){_tools.UtilTools.error("vxe.error.notType",[n])},e.onload=function(e){handleImport(o,e.target.result.trim(),i)},e.readAsText(t,"UTF-8")}):_tools.UtilTools.error("vxe.error.notType",[n])}else _tools.UtilTools.error("vxe.error.notExp")},_importData:function(e){var o=this,t=Object.assign({},_conf.default.import,e),r=new Promise(function(e,t){o._importResolve=e,o._importReject=t});return this.readFile(t).then(function(e){return o.importByFile(e.target.files[0],t)}).catch(function(e){o._importReject(e),o._importReject=null}),r},_readFile:function(e){var o=this,r=0<arguments.length&&void 0!==e?e:{};fileForm.parentNode||document.body.appendChild(fileForm);var n=r.types||_vXETable.default.importTypes;return r.multiple&&(fileInput.multiple="multiple"),fileInput.accept=".".concat(n.join(", .")),fileInput.onchange=function(e){var t=_tools.UtilTools.parseFile(e.target.files[0]).type;-1<n.indexOf(t)?o._fileResolve(e):(!1!==r.message&&o.$XModal.message({message:_xeUtils.default.template(_conf.default.i18n("vxe.error.notType"),[t]),status:"error"}),o._fileReject(e)),o._fileResolve=null},fileForm.reset(),fileInput.click(),new Promise(function(e,t){o._fileResolve=e,o._fileReject=t})},_print:function(e){this.exportData(Object.assign({original:!1},e,{type:"html",download:!1})).then(function(e){var t=e.content,o=e.blob;if(_tools.DomTools.browse.msie){if(printFrame){try{printFrame.contentDocument.write(""),printFrame.contentDocument.clear()}catch(e){}document.body.removeChild(printFrame)}printFrame=createFrame(),document.body.appendChild(printFrame),printFrame.contentDocument.write(t),printFrame.contentDocument.execCommand("print")}else printFrame||((printFrame=createFrame()).onload=function(e){e.target.src&&e.target.contentWindow.print()},document.body.appendChild(printFrame)),printFrame.src=URL.createObjectURL(o)})},_openImport:function(e){var t=Object.assign({mode:"covering",message:!0},e,this.importOpts);!this.getTreeStatus()?(this.importConfig||_tools.UtilTools.warn("vxe.error.reqProp",["import-config"]),Object.assign(this.importStore,{file:null,type:"",filename:"",visible:!0}),Object.assign(this.importParams,t)):t.message&&this.$XModal.message({message:_conf.default.i18n("vxe.error.treeNotImp"),status:"error"})},_openExport:function(e){var t=this.$toolbar,o=this.exportConfig,r=this.exportOpts,n=this.treeConfig,a=this.tableFullColumn,i=this.footerData,l=this.getCheckboxRecords(),s=a.filter(function(e){return-1<["seq","index"].indexOf(e.type)||e.property}),c=!!n,d=!!i.length,u=Object.assign({message:!0,isHeader:!0},r,e),f=u.types||_vXETable.default.exportTypes,p=r.checkMethod||(t?t.customOpts.checkMethod:null);return o||_tools.UtilTools.warn("vxe.error.reqProp",["export-config"]),u.types=f.map(function(e){return{value:e,label:"vxe.types.".concat(e)}}),s.forEach(function(e){e.checked=e.visible,e.disabled=!!p&&!p({column:e})}),Object.assign(this.exportStore,{columns:s,selectRecords:l,mode:l.length?"selected":"all",hasFooter:d,visible:!0,isTree:c}),Object.assign(this.exportParams,{filename:u.filename||"",sheetName:u.sheetName||"",type:u.type||u.types[0].value,types:u.types,original:u.original,message:u.message,isHeader:u.isHeader,isFooter:d}),this.$nextTick()},confirmExportEvent:function(e){this.exportData(Object.assign({},this.exportOpts,e))},confirmImportEvent:function(e){this.importByFile(this.importStore.file,Object.assign({},this.importOpts,e))},confirmPrintEvent:function(e){this.print(Object.assign({},this.printOpts,e))}}};exports.default=_default;