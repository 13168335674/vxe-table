"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _xeUtils=_interopRequireDefault(require("xe-utils/methods/xe-utils")),_conf=_interopRequireDefault(require("../../conf")),_vXETable=_interopRequireDefault(require("../../v-x-e-table")),_tools=require("../../tools");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}var printFrame,defaultHtmlStyle="body{margin:0}body *{-webkit-box-sizing:border-box;box-sizing:border-box;}table{font-size:14px;text-align:left;border-width:1px 0 0 1px}table,td,th{border-style:solid;border-color:#e8eaec}tfoot,thead{background-color:#f8f8f9}td,th{border-width:0 1px 1px 0}td>div,th>div{padding:.5em .4em;}.col--ellipsis>div{overflow:hidden;text-overflow:ellipsis;white-space: nowrap;word-break:break-all}.tree-icon-wrapper{position:relative;display:inline-block;vertical-align:middle;width:1.2em}.tree-icon{position:absolute;top:-.3em;left:0;width:0;height:0;border-style:solid;border-width:.5em;border-top-color:#939599;border-right-color:transparent;border-bottom-color:transparent;border-left-color:transparent}.tree-node{text-align:left}.tree-indent{display:inline-block}",fileForm=document.createElement("form"),fileInput=document.createElement("input");function createFrame(){var e=document.createElement("iframe");return e.className="vxe-table--print-frame",e}function hasTreeChildren(e,t){var o=e.treeOpts;return t[o.children]&&t[o.children].length}function handleExport(e,t,o,n){var r=getExportData(e,t,n,o),i=r.columns,l=r.datas;return e.preventEvent(null,"event.export",{$table:e,options:t,columns:i,datas:l},function(){return downloadFile(e,t,getContent(e,t,i,l))})}function getContent(e,t,o,n){switch(t.type){case"csv":return toCsv(e,t,o,n);case"txt":return toTxt(e,t,o,n);case"html":return toHtml(e,t,o,n);case"xml":return toXML(e,t,o,n)}return""}function getSeq(e,t,o,n,r){var i=e.seqOpts,l=i.seqMethod||n.indexMethod;return l?l({row:t,rowIndex:o,column:n,columnIndex:r}):(i.startIndex||e.startIndex)+o+1}function getHeaderTitle(e,t){return(e.original?t.property:t.getTitle())||""}function toCsv(r,t,e,o){var i=t.original,l="\ufeff";if(t.isHeader&&(l+=e.map(function(e){return'"'.concat(getHeaderTitle(t,e),'"')}).join(",")+"\n"),o.forEach(function(o,n){i||t.data?l+=e.map(function(e,t){return"seq"===e.type||"index"===e.type?'"'.concat(getSeq(r,o,n,e,t),'"'):'"'.concat(_tools.UtilTools.getCellValue(o,e)||"",'"')}).join(",")+"\n":l+=e.map(function(e){return'"'.concat(o[e.id],'"')}).join(",")+"\n"}),t.isFooter){var n=r.footerData;(t.footerFilterMethod?n.filter(t.footerFilterMethod):n).forEach(function(t){l+=e.map(function(e){return'"'.concat(t[r.$getColumnIndex(e)]||"",'"')}).join(",")+"\n"})}return l}function toTxt(r,t,e,o){var i=t.original,l="";if(t.isHeader&&(l+=e.map(function(e){return"".concat(getHeaderTitle(t,e))}).join("\t")+"\n"),o.forEach(function(o,n){i||t.data?l+=e.map(function(e,t){return"seq"===e.type||"index"===e.type?"".concat(getSeq(r,o,n,e,t)):"".concat(_tools.UtilTools.getCellValue(o,e)||"")}).join("\t")+"\n":l+=e.map(function(e){return"".concat(o[e.id])}).join("\t")+"\n"}),t.isFooter){var n=r.footerData;(t.footerFilterMethod?n.filter(t.footerFilterMethod):n).forEach(function(t){l+=e.map(function(e){return"".concat(t[r.$getColumnIndex(e)]||"")}).join(",")+"\n"})}return l}function toHtml(f,n,r,e){var p=f.treeConfig,m=f.treeOpts,t=f.tableFullData,o=f.showOverflow,i=f.showAllOverflow,l=f.showHeaderOverflow,a=f.showHeaderAllOverflow,h=f.scrollXLoad,v=f.scrollYLoad,g=n.original,x=_xeUtils.default.isBoolean(i)?i:o,s=_xeUtils.default.isBoolean(a)?a:l,w=["<html>","<head>",'<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no,minimal-ui"><title>'.concat(n.sheetName,"</title>"),"<style>".concat(n.style||defaultHtmlStyle,"</style>"),"</head>","<body>",'<table border="1" cellspacing="0" cellpadding="0">',"<colgroup>".concat(r.map(function(e){return'<col style="width:'.concat(e.renderWidth,'px">')}).join(""),"</colgroup>")].join("");if(n.isHeader&&(w+="<thead><tr>".concat(r.map(function(e){var t=e.showHeaderOverflow,o=_xeUtils.default.isUndefined(t)||_xeUtils.default.isNull(t)?s:t;return'<th class="'.concat(("title"===o||(!0===o||"tooltip"===o)||"ellipsis"===o?["col--ellipsis"]:[]).join(" "),'"><div style="width: ').concat(e.renderWidth,'px">').concat(getHeaderTitle(n,e),"</div></th>")}).join(""),"</tr></thead>")),e.length&&(w+="<tbody>",p?_xeUtils.default.eachTree(n.data?e:t,function(c,d,e,t,o,u){w+="<tr>",w+=g?r.map(function(e,t){var o=e.showOverflow,n="",r=_xeUtils.default.isUndefined(o)||_xeUtils.default.isNull(o)?x:o,i="ellipsis"===r,l="title"===r||(!0===r||"tooltip"===r)||i;!h&&!v||l||(i=l=!0),n="seq"===e.type||"index"===e.type?getSeq(f,c,d,e,t):_tools.UtilTools.getCellValue(c,e)||"";var a=l?["col--ellipsis"]:[];if(p&&e.treeNode){var s="";return hasTreeChildren(f,c)&&(s='<i class="tree-icon"></i>'),a.push("tree-node"),'<td class="'.concat(a.join(" "),'"><div style="width: ').concat(e.renderWidth,'px"><span class="tree-indent" style="width: ').concat((u.length-1)*m.indent,'px"></span><span class="tree-icon-wrapper">').concat(s,"</span>").concat(n,"</div></td>")}return'<td class="'.concat(a.join(" "),'"><div style="width: ').concat(e.renderWidth,'px">').concat(n,"</div></td>")}).join(""):r.map(function(e){var t=e.showOverflow,o=_xeUtils.default.isUndefined(t)||_xeUtils.default.isNull(t)?x:t,n="ellipsis"===o,r="title"===o||(!0===o||"tooltip"===o)||n;!h&&!v||r||(n=r=!0);var i=r?["col--ellipsis"]:[];if(p&&e.treeNode){var l="";return c._hasChild&&(l='<i class="tree-icon"></i>'),i.push("tree-node"),'<td class="'.concat(i.join(" "),'"><div style="width: ').concat(e.renderWidth,'px"><span class="tree-indent" style="width: ').concat((u.length-1)*m.indent,'px"></span><span class="tree-icon-wrapper">').concat(l,"</span>").concat(c[e.id],"</div></td>")}return'<td class="'.concat(i.join(" "),'"><div style="width: ').concat(e.renderWidth,'px">').concat(c[e.id],"</div></td>")}).join(""),w+="</tr>"},m):e.forEach(function(a,s){w+="<tr>",g||n.data?w+=r.map(function(e,t){var o=e.showOverflow,n="",r=_xeUtils.default.isUndefined(o)||_xeUtils.default.isNull(o)?x:o,i="ellipsis"===r,l="title"===r||(!0===r||"tooltip"===r)||i;return!h&&!v||l||(i=l=!0),n="seq"===e.type||"index"===e.type?getSeq(f,a,s,e,t):_tools.UtilTools.getCellValue(a,e)||"",'<td class="'.concat((l?["col--ellipsis"]:[]).join(" "),'"><div style="width: ').concat(e.renderWidth,'px">').concat(n,"</div></td>")}).join(""):w+=r.map(function(e){var t=e.showOverflow,o=_xeUtils.default.isUndefined(t)||_xeUtils.default.isNull(t)?x:t,n="ellipsis"===o,r="title"===o||(!0===o||"tooltip"===o)||n;return!h&&!v||r||(n=r=!0),'<td class="'.concat((r?["col--ellipsis"]:[]).join(" "),'"><div style="width: ').concat(e.renderWidth,'px">').concat(a[e.id],"</div></td>")}).join(""),w+="</tr>"}),w+="</tbody>"),n.isFooter){var c=f.footerData,d=n.footerFilterMethod?c.filter(n.footerFilterMethod):c;d.length&&(w+="<tfoot>",d.forEach(function(i){w+="<tr>".concat(r.map(function(e){var t=e.showOverflow,o=_xeUtils.default.isUndefined(t)||_xeUtils.default.isNull(t)?x:t,n="ellipsis"===o,r="title"===o||(!0===o||"tooltip"===o)||n;return!h&&!v||r||(n=r=!0),'<td class="'.concat((r?["col--ellipsis"]:[]).join(" "),'"><div style="width: ').concat(e.renderWidth,'px">').concat(i[f.$getColumnIndex(e)]||"","</div></td>")}).join(""),"</tr>")}),w+="</tfoot>")}return w+"</table></body></html>"}function toXML(r,t,e,o){var i=t.original,l=['<?xml version="1.0"?>','<?mso-application progid="Excel.Sheet"?>','<Workbook xmlns="urn:schemas-microsoft-com:office:spreadsheet" xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns:ss="urn:schemas-microsoft-com:office:spreadsheet" xmlns:html="http://www.w3.org/TR/REC-html40">','<DocumentProperties xmlns="urn:schemas-microsoft-com:office:office">',"<Version>16.00</Version>","</DocumentProperties>",'<ExcelWorkbook xmlns="urn:schemas-microsoft-com:office:excel">',"<WindowHeight>7920</WindowHeight>","<WindowWidth>21570</WindowWidth>","<WindowTopX>32767</WindowTopX>","<WindowTopY>32767</WindowTopY>","<ProtectStructure>False</ProtectStructure>","<ProtectWindows>False</ProtectWindows>","</ExcelWorkbook>",'<Worksheet ss:Name="'.concat(t.sheetName,'">'),"<Table>",e.map(function(e){return'<Column ss:Width="'.concat(e.renderWidth,'"/>')}).join("")].join("");if(t.isHeader&&(l+="<Row>".concat(e.map(function(e){return'<Cell><Data ss:Type="String">'.concat(getHeaderTitle(t,e),"</Data></Cell>")}).join(""),"</Row>")),o.forEach(function(o,n){l+="<Row>",i||t.data?l+=e.map(function(e,t){return"seq"===e.type||"index"===e.type?'<Cell><Data ss:Type="String">'.concat(getSeq(r,o,n,e,t),"</Data></Cell>"):'<Cell><Data ss:Type="String">'.concat(_tools.UtilTools.getCellValue(o,e)||"","</Data></Cell>")}).join(""):l+=e.map(function(e){return'<Cell><Data ss:Type="String">'.concat(o[e.id],"</Data></Cell>")}).join(""),l+="</Row>"}),t.isFooter){var n=r.footerData;(t.footerFilterMethod?n.filter(t.footerFilterMethod):n).forEach(function(t){l+="<Row>".concat(e.map(function(e){return'<Cell><Data ss:Type="String">'.concat(t[r.$getColumnIndex(e)||""],"</Data></Cell>")}).join(""),"</Row>")})}return"".concat(l,"</Table></Worksheet></Workbook>")}function downloadFile(e,t,o){var n=t.filename,r=t.type,i=t.download,l="".concat(n,".").concat(r);if(window.Blob){var a=new Blob([o],{type:"text/".concat(r)});if(!i)return Promise.resolve({type:r,content:o,blob:a});if(navigator.msSaveBlob)navigator.msSaveBlob(a,l);else{var s=document.createElement("a");s.target="_blank",s.download=l,s.href=URL.createObjectURL(a),document.body.appendChild(s),s.click(),document.body.removeChild(s)}!1!==t.message&&e.$XModal.message({message:_conf.default.i18n("vxe.table.expSuccess"),status:"success"})}else _tools.UtilTools.error("vxe.error.notExp")}function getLabelData(r,e,t){var i=r.treeConfig;return t.map(function(o){var n={_hasChild:i&&hasTreeChildren(r,o)};return e.forEach(function(e){var t=_tools.DomTools.getCell(r,{row:o,column:e});n[e.id]=t?t.innerText.trim():""}),n})}function getExportData(e,t,o,n){var r=t.columns?t.columns:n,i=t.data||o;return t.columnFilterMethod&&(r=r.filter(t.columnFilterMethod)),t.dataFilterMethod&&(i=i.filter(t.dataFilterMethod)),{columns:r,datas:t.original||t.data?i:getLabelData(e,r,i)}}function replaceDoubleQuotation(e){return e.replace(/^"/,"").replace(/"$/,"")}function parseCsv(e,t){var o=t.split("\n"),n=[],r=[];if(o.length){var i=o.slice(1);r=o[0].split(",").map(replaceDoubleQuotation),i.forEach(function(e){if(e){var o={};e.split(",").forEach(function(e,t){r[t]&&(o[r[t]]=replaceDoubleQuotation(e))}),n.push(o)}})}return{fields:r,rows:n}}function parseTxt(e,t){var o=t.split("\n"),n=[],r=[];if(o.length){var i=o.slice(1);r=o[0].split("\t"),i.forEach(function(e){if(e){var o={};e.split("\t").forEach(function(e,t){r[t]&&(o[r[t]]=replaceDoubleQuotation(e))}),n.push(o)}})}return{fields:r,rows:n}}function parseHTML(e,t){var o=getElementsByTagName((new DOMParser).parseFromString(t,"text/html"),"body"),n=[],r=[];if(o.length){var i=getElementsByTagName(o[0],"table");if(i.length){var l=getElementsByTagName(i[0],"thead");if(l.length){_xeUtils.default.arrayEach(getElementsByTagName(l[0],"tr"),function(e){_xeUtils.default.arrayEach(getElementsByTagName(e,"th"),function(e){r.push(e.textContent)})});var a=getElementsByTagName(i[0],"tbody");a.length&&_xeUtils.default.arrayEach(getElementsByTagName(a[0],"tr"),function(e){var o={};_xeUtils.default.arrayEach(getElementsByTagName(e,"td"),function(e,t){r[t]&&(o[r[t]]=e.textContent||"")}),n.push(o)})}}}return{fields:r,rows:n}}function parseXML(e,t){var o=getElementsByTagName((new DOMParser).parseFromString(t,"application/xml"),"Worksheet"),r=[],i=[];if(o.length){var n=getElementsByTagName(o[0],"Table");if(n.length){var l=getElementsByTagName(n[0],"Row");l.length&&(_xeUtils.default.arrayEach(getElementsByTagName(l[0],"Cell"),function(e){i.push(e.textContent)}),_xeUtils.default.arrayEach(l,function(e,t){if(t){var o={},n=getElementsByTagName(e,"Cell");_xeUtils.default.arrayEach(n,function(e,t){i[t]&&(o[i[t]]=e.textContent)}),r.push(o)}}))}}return{fields:i,rows:r}}function getElementsByTagName(e,t){return e.getElementsByTagName(t)}function checkImportData(e,t,o){var n=[];return e.forEach(function(e){var t=e.property;t&&n.push(t)}),n.every(function(e){return _xeUtils.default.includes(t,e)})}function handleImport(t,e,o){var n=t.tableFullColumn,r=t._importResolve,i={fields:[],rows:[]};switch(o.type){case"csv":i=parseCsv(n,e);break;case"txt":i=parseTxt(n,e);break;case"html":i=parseHTML(n,e);break;case"xml":i=parseXML(n,e)}var l=i.fields,a=i.rows,s=checkImportData(n,l,a);s?(t.createData(a).then(function(e){"append"===o.mode?t.insertAt(e,-1):t.reloadData(e)}),!1!==o.message&&t.$XModal.message({message:_conf.default.i18n("vxe.table.impSuccess"),status:"success"})):!1!==o.message&&t.$XModal.message({message:_conf.default.i18n("vxe.error.impFields"),status:"error"}),r&&(r(s),t._importResolve=null)}fileForm.className="vxe-table--import-form",fileInput.name="file",fileInput.type="file",fileForm.appendChild(fileInput);var _default={methods:{_exportCsv:function(e){return _tools.UtilTools.warn("vxe.error.delFunc",["exportCsv","exportData"]),this.exportData(e)},_openExport:function(e){if(this.$toolbar)return this.$toolbar.openExport(e);throw new Error(_tools.UtilTools.getLog("vxe.error.barUnableLink"))},_exportData:function(e){var t=this.visibleColumn,o=this.scrollXLoad,n=this.scrollYLoad,r=this.treeConfig,i=this.treeOpts,l=Object.assign({filename:"",sheetName:"",original:!!r,message:!1,isHeader:!0,isFooter:!0,download:!0,type:"csv",data:null,columns:null,columnFilterMethod:e.columns?null:function(e){return-1<["seq","index"].indexOf(e.type)||e.property},dataFilterMethod:null,footerFilterMethod:null},_conf.default.export,e);if(l.filename||(l.filename="export"),l.sheetName||(l.sheetName="Sheet1"),!_xeUtils.default.includes(_vXETable.default.exportTypes,l.type))throw new Error(_tools.UtilTools.getLog("vxe.error.notType",[l.type]));l.original||(o||n)&&(l.original=!0,_tools.UtilTools.warn("vxe.error.scrollOriginal"));var a=t,s=this.tableFullData;return r&&(s=_xeUtils.default.toTreeArray(s,i)),handleExport(this,l,a,s)},_openImport:function(e){if(this.$toolbar)return this.$toolbar.openImport(e);throw new Error(_tools.UtilTools.getLog("vxe.error.barUnableLink"))},_importByFile:function(t,e){var o=this;if(window.FileReader){var n=_tools.UtilTools.parseFile(t),r=n.type,i=n.filename,l=Object.assign({mode:"covering"},e,{type:r,filename:i}),a=l.types||_vXETable.default.importTypes;_xeUtils.default.includes(a,r)?this.preventEvent(null,"event.import",{$table:this,file:t,options:l,columns:this.tableFullColumn},function(){var e=new FileReader;e.onerror=function(e){_tools.UtilTools.error("vxe.error.notType",[r])},e.onload=function(e){handleImport(o,e.target.result.trim(),l)},e.readAsText(t,"UTF-8")}):_tools.UtilTools.error("vxe.error.notType",[r])}else _tools.UtilTools.error("vxe.error.notExp")},_importData:function(e){var o=this,t=Object.assign({},_conf.default.import,e),n=new Promise(function(e,t){o._importResolve=e,o._importReject=t});return this.readFile(t).then(function(e){return o.importByFile(e.target.files[0],t)}).catch(function(e){o._importReject(e),o._importReject=null}),n},_readFile:function(e){var o=this,n=0<arguments.length&&void 0!==e?e:{};fileForm.parentNode||document.body.appendChild(fileForm);var r=n.types||_vXETable.default.importTypes;return n.multiple&&(fileInput.multiple="multiple"),fileInput.accept=".".concat(r.join(", .")),fileInput.onchange=function(e){var t=_tools.UtilTools.parseFile(e.target.files[0]).type;_xeUtils.default.includes(r,t)?o._fileResolve(e):(!1!==n.message&&o.$XModal.message({message:_xeUtils.default.template(_conf.default.i18n("vxe.error.notType"),[t]),status:"error"}),o._fileReject(e)),o._fileResolve=null},fileForm.reset(),fileInput.click(),new Promise(function(e,t){o._fileResolve=e,o._fileReject=t})},_print:function(e){this.exportData(Object.assign({original:this.scrollXLoad||this.scrollYLoad},e,{type:"html",download:!1})).then(function(e){var t=e.content,o=e.blob;if(_tools.DomTools.browse.msie){if(printFrame){try{printFrame.contentDocument.write(""),printFrame.contentDocument.clear()}catch(e){}document.body.removeChild(printFrame)}printFrame=createFrame(),document.body.appendChild(printFrame),printFrame.contentDocument.write(t),printFrame.contentDocument.execCommand("print")}else printFrame||((printFrame=createFrame()).onload=function(e){e.target.src&&e.target.contentWindow.print()},document.body.appendChild(printFrame)),printFrame.src=URL.createObjectURL(o)})}}};exports.default=_default;