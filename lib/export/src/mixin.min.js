"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _xeUtils=_interopRequireDefault(require("xe-utils/methods/xe-utils")),_tools=require("../../tools");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function getCsvContent(e,t,o,n){var l=t.original,r=getCsvData(e,t,n,o),a=r.columns,i=r.datas,s="\ufeff";if(t.isHeader&&(s+=a.map(function(e){var t=e.own;return _tools.UtilTools.getFuncText(t.title||t.label)}).join(",")+"\n"),i.forEach(function(t,o){s+=l?a.map(function(e){return"index"===e.type?'"'.concat(e.indexMethod?e.indexMethod(o):o+1,'"'):'"'.concat(_tools.UtilTools.getCellValue(t,e)||"",'"')}).join(",")+"\n":a.map(function(e){return'"'.concat(t[e.id],'"')}).join(",")+"\n"}),t.isFooter){var u=e.footerData,c=t.footerFilterMethod?u.filter(t.footerFilterMethod):u,d=e.tableColumn.map(function(e){return a.includes(e)});c.forEach(function(e){s+=e.filter(function(e,t){return d[t]}).join(",")+"\n"})}return s}function downloadCsc(e,t){if(!e.download)return Promise.resolve(t);if(navigator.msSaveBlob&&window.Blob)navigator.msSaveBlob(new Blob([t],{type:"text/csv"}),e.filename);else if(_tools.DomTools.browse["-ms"]){var o=window.top.open("about:blank","_blank");o.document.charset="utf-8",o.document.write(t),o.document.close(),o.document.execCommand("SaveAs",e.filename),o.close()}else{var n=document.createElement("a");n.target="_blank",n.download=e.filename,n.href=getCsvUrl(e,t),document.body.appendChild(n),n.click(),document.body.removeChild(n)}}function getCsvLabelData(l,e,t){return t.map(function(o){var n={};return e.forEach(function(e){var t=_tools.DomTools.getCell(l,{row:o,column:e});n[e.id]=t?t.innerText.trim():""}),n})}function getCsvData(e,t,o,n){var l=t.columns?t.columns:n,r=t.data||o;return t.columnFilterMethod&&(l=l.filter(t.columnFilterMethod)),t.dataFilterMethod&&(r=r.filter(t.dataFilterMethod)),{columns:l,datas:t.original?r:getCsvLabelData(e,l,r)}}function getCsvUrl(e,t){return window.Blob&&window.URL&&window.URL.createObjectURL&&!_tools.DomTools.browse.safari?URL.createObjectURL(new Blob([t],{type:"text/csv"})):"data:attachment/csv;charset=utf-8,".concat(encodeURIComponent(t))}var _default={methods:{_exportCsv:function(e){var t=this.visibleColumn,o=this.scrollXLoad,n=this.scrollYLoad,l=this.treeConfig,r=Object.assign({filename:"",original:!!l,isHeader:!0,isFooter:!0,download:!0,data:null,columns:null,columnFilterMethod:function(e){return e.property&&-1===["index","checkbox","selection","radio"].indexOf(e.type)},dataFilterMethod:null,footerFilterMethod:null},e);r.filename?-1===r.filename.indexOf(".csv")&&(r.filename+=".csv"):r.filename="table.csv",r.original||(o||n)&&(r.original=!0,_tools.UtilTools.warn("vxe.error.scrollOriginal"));var a=t,i=this.tableFullData;return l&&(i=_xeUtils.default.toTreeArray(i,l)),downloadCsc(r,getCsvContent(this,r,a,i))}}};exports.default=_default;