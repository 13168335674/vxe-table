"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _xeUtils=_interopRequireDefault(require("xe-utils/methods/xe-utils")),_tools=require("../../tools"),_vXETable=_interopRequireDefault(require("../../v-x-e-table"));function _interopRequireDefault(t){return t&&t.__esModule?t:{default:t}}function handleExport(t,e,o,n){var r=getExportData(t,e,n,o),i=r.columns,a=r.datas;return t.preventEvent(null,"event.export",{$table:t,options:e,columns:i,datas:a},function(){return downloadFile(e,getContent(t,e,i,a))})}function getContent(t,e,o,n){var r=e.type;return"csv"===r?toCsv(t,e,o,n):"txt"===r?toTxt(t,e,o,n):"html"===r?toHtml(t,e,o,n):"xml"===r?toXML(t,e,o,n):""}function toCsv(t,e,n,o){var r=e.original,i="\ufeff";if(e.isHeader&&(i+=n.map(function(t){return'"'.concat(t.getTitle(),'"')}).join(",")+"\n"),o.forEach(function(e,o){i+=r?n.map(function(t){return"index"===t.type?'"'.concat(t.indexMethod?t.indexMethod(o):o+1,'"'):'"'.concat(_tools.UtilTools.getCellValue(e,t)||"",'"')}).join(",")+"\n":n.map(function(t){return'"'.concat(e[t.id],'"')}).join(",")+"\n"}),e.isFooter){var a=t.footerData,l=e.footerFilterMethod?a.filter(e.footerFilterMethod):a,c=t.tableColumn.map(function(t){return n.includes(t)});l.forEach(function(t){i+=t.filter(function(t,e){return'"'.concat(c[e],'"')}).join(",")+"\n"})}return i}function toTxt(t,e,n,o){var r=e.original,i="";if(e.isHeader&&(i+=n.map(function(t){return"".concat(t.getTitle())}).join("\t")+"\n"),o.forEach(function(e,o){i+=r?n.map(function(t){return"index"===t.type?"".concat(t.indexMethod?t.indexMethod(o):o+1):'"'.concat(_tools.UtilTools.getCellValue(e,t)||"",'"')}).join("\t")+"\n":n.map(function(t){return"".concat(e[t.id])}).join("\t")+"\n"}),e.isFooter){var a=t.footerData,l=e.footerFilterMethod?a.filter(e.footerFilterMethod):a,c=t.tableColumn.map(function(t){return n.includes(t)});l.forEach(function(t){i+=t.filter(function(t,e){return"".concat(c[e])}).join("\t")+"\n"})}return i}function toHtml(t,e,n,o){var r=e.original,i=["<!DOCTYPE html>","<html>",'<head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no,minimal-ui"><title>'.concat(e.filename,"</title></head>"),"<body>",'<table border="1" cellspacing="0" cellpadding="0">',"<colgroup>".concat(n.map(function(t){return'<col width="'.concat(t.renderWidth,'">')}).join(""),"</colgroup>")].join("");if(e.isHeader&&(i+="<thead><tr>".concat(n.map(function(t){return"<th>".concat(t.getTitle(),"</th>")}).join(""),"</tr></thead>")),o.length&&(i+="<tbody>",o.forEach(function(e,o){i+="<tr>",i+=r?n.map(function(t){return"index"===t.type?"<td>".concat(t.indexMethod?t.indexMethod(o):o+1,"</td>"):"<td>".concat(_tools.UtilTools.getCellValue(e,t)||"","</td>")}).join(""):n.map(function(t){return"<td>".concat(e[t.id],"</td>")}).join(""),i+="</tr>"}),i+="</tbody>"),e.isFooter){var a=t.footerData,l=e.footerFilterMethod?a.filter(e.footerFilterMethod):a,c=t.tableColumn.map(function(t){return n.includes(t)});l.length&&(i+="<tfoot>",l.forEach(function(t){i+="<tr>".concat(t.filter(function(t,e){return"<td>".concat(c[e],"</td>")}).join(""),"</tr>")}),i+="</tfoot>")}return i+"</table></body></html>"}function toXML(t,e,n,o){var r=e.original,i=['<?xml version="1.0"?>','<?mso-application progid="Excel.Sheet"?>','<Workbook xmlns="urn:schemas-microsoft-com:office:spreadsheet" xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns:ss="urn:schemas-microsoft-com:office:spreadsheet" xmlns:html="http://www.w3.org/TR/REC-html40">','<DocumentProperties xmlns="urn:schemas-microsoft-com:office:office">',"<Version>16.00</Version>","</DocumentProperties>",'<ExcelWorkbook xmlns="urn:schemas-microsoft-com:office:excel">',"<WindowHeight>7920</WindowHeight>","<WindowWidth>21570</WindowWidth>","<WindowTopX>32767</WindowTopX>","<WindowTopY>32767</WindowTopY>","<ProtectStructure>False</ProtectStructure>","<ProtectWindows>False</ProtectWindows>","</ExcelWorkbook>",'<Worksheet ss:Name="'.concat(e.filename,'">'),"<Table>",n.map(function(t){return'<Column ss:Width="'.concat(t.renderWidth,'"/>')}).join("")].join("");if(e.isHeader&&(i+="<Row>".concat(n.map(function(t){return'<Cell><Data ss:Type="String">'.concat(t.getTitle(),"</Data></Cell>")}).join(""),"</Row>")),o.forEach(function(e,o){i+="<Row>",i+=r?n.map(function(t){return"index"===t.type?'<Cell><Data ss:Type="String">'.concat(t.indexMethod?t.indexMethod(o):o+1,"</Data></Cell>"):'<Cell><Data ss:Type="String">'.concat(_tools.UtilTools.getCellValue(e,t)||"","</Data></Cell>")}).join(""):n.map(function(t){return'<Cell><Data ss:Type="String">'.concat(e[t.id],"</Data></Cell>")}).join(""),i+="</Row>"}),e.isFooter){var a=t.footerData,l=e.footerFilterMethod?a.filter(e.footerFilterMethod):a,c=t.tableColumn.map(function(t){return n.includes(t)});l.length&&l.forEach(function(t){i+="<Row>".concat(t.filter(function(t,e){return'<Cell><Data ss:Type="String">'.concat(c[e],"</Data></Cell>")}).join(""),"</Row>")})}return"".concat(i,"</Table></Worksheet></Workbook>")}function downloadFile(t,e){var o=t.filename,n=t.type,r=t.download,i="".concat(o,".").concat(n);if(!r)return Promise.resolve(e);if(navigator.msSaveBlob&&window.Blob)navigator.msSaveBlob(new Blob([e],{type:"text/".concat(n)}),i);else if(_tools.DomTools.browse["-ms"]){var a=window.top.open("about:blank","_blank");a.document.charset="utf-8",a.document.write(e),a.document.close(),a.document.execCommand("SaveAs",i),a.close()}else{var l=document.createElement("a");l.target="_blank",l.download=i,l.href=getDownloadUrl(t,e),document.body.appendChild(l),l.click(),document.body.removeChild(l)}}function getLabelData(r,t,e){return e.map(function(o){var n={};return t.forEach(function(t){var e=_tools.DomTools.getCell(r,{row:o,column:t});n[t.id]=e?e.innerText.trim():""}),n})}function getExportData(t,e,o,n){var r=e.columns?e.columns:n,i=e.data||o;return e.columnFilterMethod&&(r=r.filter(e.columnFilterMethod)),e.dataFilterMethod&&(i=i.filter(e.dataFilterMethod)),{columns:r,datas:e.original?i:getLabelData(t,r,i)}}function getDownloadUrl(t,e){switch(t.type){case"csv":case"html":case"xml":case"txt":return getAttachmentUrl(t,e)}return""}function getAttachmentUrl(t,e){var o=t.type;return window.Blob&&window.URL&&window.URL.createObjectURL&&!_tools.DomTools.browse.safari?URL.createObjectURL(new Blob([e],{type:"text/".concat(o)})):"data:attachment/".concat(o,";charset=utf-8,").concat(encodeURIComponent(e))}var _default={methods:{_exportCsv:function(t){return this.exportData(t)},_exportData:function(t){var e=this.visibleColumn,o=this.scrollXLoad,n=this.scrollYLoad,r=this.treeConfig,i=Object.keys(_vXETable.default.types),a=Object.assign({filename:"",original:!!r,isHeader:!0,isFooter:!0,download:!0,type:"csv",data:null,columns:null,columnFilterMethod:null,dataFilterMethod:null,footerFilterMethod:null},t);if(a.filename||(a.filename="table"),!i.includes(a.type))throw new Error(_tools.UtilTools.getLog("vxe.error.notType",[a.type]));a.original||(o||n)&&(a.original=!0,_tools.UtilTools.warn("vxe.error.scrollOriginal")),t&&t.columns||(a.columnFilterMethod=function(t){return t.property&&-1===["index","checkbox","selection","radio"].indexOf(t.type)});var l=e,c=this.tableFullData;return r&&(c=_xeUtils.default.toTreeArray(c,r)),handleExport(this,a,l,c)}}};exports.default=_default;