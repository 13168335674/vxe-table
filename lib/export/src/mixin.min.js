"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _xeUtils=_interopRequireDefault(require("xe-utils/methods/xe-utils")),_conf=_interopRequireDefault(require("../../conf")),_vXETable=_interopRequireDefault(require("../../v-x-e-table")),_tools=require("../../tools");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function getFileTypes(){return Object.keys(_vXETable.default.types)}function handleExport(e,t,o,n){var r=getExportData(e,t,n,o),a=r.columns,i=r.datas;return e.preventEvent(null,"event.export",{$table:e,options:t,columns:a,datas:i},function(){return downloadFile(e,t,getContent(e,t,a,i))})}function getContent(e,t,o,n){switch(t.type){case"csv":return toCsv(e,t,o,n);case"txt":return toTxt(e,t,o,n);case"html":return toHtml(e,t,o,n);case"xml":return toXML(e,t,o,n)}return""}function getHeaderTitle(e,t){return e.original?t.property:t.getTitle()}function toCsv(e,t,n,o){var r=t.original,a="\ufeff";if(t.isHeader&&(a+=n.map(function(e){return'"'.concat(getHeaderTitle(t,e),'"')}).join(",")+"\n"),o.forEach(function(t,o){a+=r?n.map(function(e){return"index"===e.type?'"'.concat(e.indexMethod?e.indexMethod(o):o+1,'"'):'"'.concat(_tools.UtilTools.getCellValue(t,e)||"",'"')}).join(",")+"\n":n.map(function(e){return'"'.concat(t[e.id],'"')}).join(",")+"\n"}),t.isFooter){var i=e.footerData,l=t.footerFilterMethod?i.filter(t.footerFilterMethod):i,c=e.tableColumn.map(function(e){return n.includes(e)});l.forEach(function(e){a+=e.map(function(e,t){return'"'.concat(c[t],'"')}).join(",")+"\n"})}return a}function toTxt(e,t,n,o){var r=t.original,a="";if(t.isHeader&&(a+=n.map(function(e){return"".concat(getHeaderTitle(t,e))}).join("\t")+"\n"),o.forEach(function(t,o){a+=r?n.map(function(e){return"index"===e.type?"".concat(e.indexMethod?e.indexMethod(o):o+1):"".concat(_tools.UtilTools.getCellValue(t,e)||"")}).join("\t")+"\n":n.map(function(e){return"".concat(t[e.id])}).join("\t")+"\n"}),t.isFooter){var i=e.footerData,l=t.footerFilterMethod?i.filter(t.footerFilterMethod):i,c=e.tableColumn.map(function(e){return n.includes(e)});l.forEach(function(e){a+=e.map(function(e,t){return"".concat(c[t])}).join("\t")+"\n"})}return a}function toHtml(e,t,n,o){var r=t.original,a=["<!DOCTYPE html>","<html>",'<head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no,minimal-ui"><title>'.concat(t.sheetName,"</title></head>"),"<body>",'<table border="1" cellspacing="0" cellpadding="0">',"<colgroup>".concat(n.map(function(e){return'<col width="'.concat(e.renderWidth,'">')}).join(""),"</colgroup>")].join("");if(t.isHeader&&(a+="<thead><tr>".concat(n.map(function(e){return"<th>".concat(getHeaderTitle(t,e),"</th>")}).join(""),"</tr></thead>")),o.length&&(a+="<tbody>",o.forEach(function(t,o){a+="<tr>",a+=r?n.map(function(e){return"index"===e.type?"<td>".concat(e.indexMethod?e.indexMethod(o):o+1,"</td>"):"<td>".concat(_tools.UtilTools.getCellValue(t,e)||"","</td>")}).join(""):n.map(function(e){return"<td>".concat(t[e.id],"</td>")}).join(""),a+="</tr>"}),a+="</tbody>"),t.isFooter){var i=e.footerData,l=t.footerFilterMethod?i.filter(t.footerFilterMethod):i,c=e.tableColumn.map(function(e){return n.includes(e)});l.length&&(a+="<tfoot>",l.forEach(function(e){a+="<tr>".concat(e.map(function(e,t){return"<td>".concat(c[t],"</td>")}).join(""),"</tr>")}),a+="</tfoot>")}return a+"</table></body></html>"}function toXML(e,t,n,o){var r=t.original,a=['<?xml version="1.0"?>','<?mso-application progid="Excel.Sheet"?>','<Workbook xmlns="urn:schemas-microsoft-com:office:spreadsheet" xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns:ss="urn:schemas-microsoft-com:office:spreadsheet" xmlns:html="http://www.w3.org/TR/REC-html40">','<DocumentProperties xmlns="urn:schemas-microsoft-com:office:office">',"<Version>16.00</Version>","</DocumentProperties>",'<ExcelWorkbook xmlns="urn:schemas-microsoft-com:office:excel">',"<WindowHeight>7920</WindowHeight>","<WindowWidth>21570</WindowWidth>","<WindowTopX>32767</WindowTopX>","<WindowTopY>32767</WindowTopY>","<ProtectStructure>False</ProtectStructure>","<ProtectWindows>False</ProtectWindows>","</ExcelWorkbook>",'<Worksheet ss:Name="'.concat(t.sheetName,'">'),"<Table>",n.map(function(e){return'<Column ss:Width="'.concat(e.renderWidth,'"/>')}).join("")].join("");if(t.isHeader&&(a+="<Row>".concat(n.map(function(e){return'<Cell><Data ss:Type="String">'.concat(getHeaderTitle(t,e),"</Data></Cell>")}).join(""),"</Row>")),o.forEach(function(t,o){a+="<Row>",a+=r?n.map(function(e){return"index"===e.type?'<Cell><Data ss:Type="String">'.concat(e.indexMethod?e.indexMethod(o):o+1,"</Data></Cell>"):'<Cell><Data ss:Type="String">'.concat(_tools.UtilTools.getCellValue(t,e)||"","</Data></Cell>")}).join(""):n.map(function(e){return'<Cell><Data ss:Type="String">'.concat(t[e.id],"</Data></Cell>")}).join(""),a+="</Row>"}),t.isFooter){var i=e.footerData,l=t.footerFilterMethod?i.filter(t.footerFilterMethod):i,c=e.tableColumn.map(function(e){return n.includes(e)});l.length&&l.forEach(function(e){a+="<Row>".concat(e.map(function(e,t){return'<Cell><Data ss:Type="String">'.concat(c[t],"</Data></Cell>")}).join(""),"</Row>")})}return"".concat(a,"</Table></Worksheet></Workbook>")}function downloadFile(e,t,o){var n=t.filename,r=t.type,a=t.download,i="".concat(n,".").concat(r);if(!a)return Promise.resolve(o);if(window.Blob){var l=new Blob([o],{type:"text/".concat(r)});if(navigator.msSaveBlob)navigator.msSaveBlob(l,i);else{var c=document.createElement("a");c.target="_blank",c.download=i,c.href=URL.createObjectURL(l),document.body.appendChild(c),c.click(),document.body.removeChild(c)}t.message&&e.$XModal.message({message:_conf.default.i18n("vxe.table.expSuccess"),status:"success"})}else _tools.UtilTools.error("vxe.error.notExp")}function getLabelData(r,e,t){return t.map(function(o){var n={};return e.forEach(function(e){var t=_tools.DomTools.getCell(r,{row:o,column:e});n[e.id]=t?t.innerText.trim():""}),n})}function getExportData(e,t,o,n){var r=t.columns?t.columns:n,a=t.data||o;return t.columnFilterMethod&&(r=r.filter(t.columnFilterMethod)),t.dataFilterMethod&&(a=a.filter(t.dataFilterMethod)),{columns:r,datas:t.original?a:getLabelData(e,r,a)}}function replaceDoubleQuotation(e){return e.replace(/^"/,"").replace(/"$/,"")}function parseCsv(e,t){var o=t.split("\n"),n=[],r=[];if(o.length){var a=o.slice(1);o[0].split(",").forEach(function(e){var t=replaceDoubleQuotation(e);t&&n.push(t)}),a.forEach(function(e){if(e){var o={};e.split(",").forEach(function(e,t){o[n[t]]=replaceDoubleQuotation(e)}),r.push(o)}})}return{fields:n,rows:r}}function parseTxt(e,t){var o=t.split("\n"),n=[],r=[];if(o.length){var a=o.slice(1);o[0].split("\t").forEach(function(e){e&&n.push(e)}),a.forEach(function(e){if(e){var o={};e.split("\t").forEach(function(e,t){o[n[t]]=replaceDoubleQuotation(e)}),r.push(o)}})}return{fields:n,rows:r}}function parseHTML(e,t){var o=getElementsByTagName((new DOMParser).parseFromString(t,"text/html"),"body"),n=[],r=[];if(o.length){var a=getElementsByTagName(o[0],"table");if(a.length){var i=getElementsByTagName(a[0],"thead");if(i.length){_xeUtils.default.arrayEach(getElementsByTagName(i[0],"tr"),function(e){_xeUtils.default.arrayEach(getElementsByTagName(e,"th"),function(e){var t=e.textContent;t&&n.push(t)})});var l=getElementsByTagName(a[0],"tbody");l.length&&_xeUtils.default.arrayEach(getElementsByTagName(l[0],"tr"),function(e){var o={};_xeUtils.default.arrayEach(getElementsByTagName(e,"td"),function(e,t){o[n[t]]=e.textContent||""}),r.push(o)})}}}return{fields:n,rows:r}}function parseXML(e,t){var o=getElementsByTagName((new DOMParser).parseFromString(t,"application/xml"),"Worksheet"),r=[],a=[];if(o.length){var n=getElementsByTagName(o[0],"Table");if(n.length){var i=getElementsByTagName(n[0],"Row");i.length&&(_xeUtils.default.arrayEach(getElementsByTagName(i[0],"Cell"),function(e){var t=e.textContent;t&&r.push(t)}),_xeUtils.default.arrayEach(i,function(e,t){if(t){var o={},n=getElementsByTagName(e,"Cell");_xeUtils.default.arrayEach(n,function(e,t){o[r[t]]=e.textContent}),a.push(o)}}))}}return{fields:r,rows:a}}function getElementsByTagName(e,t){return e.getElementsByTagName(t)}function checkImportData(e,t,o){var n=[];return e.forEach(function(e){var t=e.property;t&&n.push(t)}),n.every(function(e){return t.includes(e)})}function handleImport(t,e,o){var n=t.tableFullColumn,r=t._importCallback,a={fields:[],rows:[]};switch(o.type){case"csv":a=parseCsv(n,e);break;case"txt":a=parseTxt(n,e);break;case"html":a=parseHTML(n,e);break;case"xml":a=parseXML(n,e)}var i=a,l=i.fields,c=i.rows,s=checkImportData(n,l,c);s?(t.createData(c).then(function(e){"append"===o.mode?t.insertAt(e,-1):t.reloadData(e)}),o.message&&t.$XModal.message({message:_conf.default.i18n("vxe.table.impSuccess"),status:"success"})):o.message&&t.$XModal.message({message:_conf.default.i18n("vxe.error.impFields"),status:"error"}),r&&r(s)}var _default={methods:{_exportCsv:function(e){return _tools.UtilTools.warn("vxe.error.delFunc",["exportCsv","exportData"]),this.exportData(e)},_openExport:function(e){if(this.$toolbar)return this.$toolbar.openExport(e);throw new Error(_tools.UtilTools.getLog("vxe.error.barUnableLink"))},_exportData:function(e){var t=this.visibleColumn,o=this.scrollXLoad,n=this.scrollYLoad,r=this.treeConfig,a=Object.keys(_vXETable.default.types),i=Object.assign({filename:"",sheetName:"",original:!!r,message:!1,isHeader:!0,isFooter:!0,download:!0,type:"csv",data:null,columns:null,columnFilterMethod:null,dataFilterMethod:null,footerFilterMethod:null},e);if(i.filename||(i.filename="export"),i.sheetName||(i.sheetName="Sheet1"),!a.includes(i.type))throw new Error(_tools.UtilTools.getLog("vxe.error.notType",[i.type]));i.original||(o||n)&&(i.original=!0,_tools.UtilTools.warn("vxe.error.scrollOriginal")),e&&e.columns||(i.columnFilterMethod=function(e){return e.property&&-1===["index","checkbox","selection","radio"].indexOf(e.type)});var l=t,c=this.tableFullData;return r&&(c=_xeUtils.default.toTreeArray(c,r)),handleExport(this,i,l,c)},_openImport:function(e){if(this.$toolbar)return this.$toolbar.openImport(e);throw new Error(_tools.UtilTools.getLog("vxe.error.barUnableLink"))},_importByFile:function(t,e){var o=this;if(window.FileReader){var n=_tools.UtilTools.parseFile(t),r=n.type,a=n.filename,i=Object.assign({mode:"covering"},e,{type:r,filename:a});getFileTypes().includes(r)?this.preventEvent(null,"event.import",{$table:this,file:t,options:i,columns:this.tableFullColumn},function(){var e=new FileReader;e.onerror=function(e){_tools.UtilTools.error("vxe.error.notType",[r])},e.onload=function(e){handleImport(o,e.target.result.trim(),i)},e.readAsText(t,"UTF-8")}):_tools.UtilTools.error("vxe.error.notType",[r])}else _tools.UtilTools.error("vxe.error.notExp")},_importData:function(t){var o=this;return this.readFile().then(function(e){return o.importByFile(e.target.files[0],t)}),new Promise(function(e){o._importCallback=e})},_readFile:function(){var t=this,e=this.$refs,o=e.impForm,n=e.impInput;return n.accept=".".concat(getFileTypes().join(", .")),o.reset(),n.click(),new Promise(function(e){t._fileCallback=e})},fileChangeEvent:function(e){this._fileCallback(e),this._fileCallback=null}}};exports.default=_default;