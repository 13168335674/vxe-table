"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _xeUtils=_interopRequireDefault(require("xe-utils/methods/xe-utils")),_tools=require("../../tools");function _interopRequireDefault(t){return t&&t.__esModule?t:{default:t}}function getContent(t,e,o,n){var r=e.type,l=getExportData(t,e,n,o),a=l.columns,i=l.datas;return"csv"===r?toCsv(t,e,a,i):"html"===r?toHtml(t,e,a,i):""}function toCsv(t,e,n,o){var r=e.original,l="\ufeff";if(e.isHeader&&(l+=n.map(function(t){var e=t.own;return'"'.concat(_tools.UtilTools.getFuncText(e.title||e.label),'"')}).join(",")+"\n"),o.forEach(function(e,o){l+=r?n.map(function(t){return"index"===t.type?'"'.concat(t.indexMethod?t.indexMethod(o):o+1,'"'):'"'.concat(_tools.UtilTools.getCellValue(e,t)||"",'"')}).join(",")+"\n":n.map(function(t){return'"'.concat(e[t.id],'"')}).join(",")+"\n"}),e.isFooter){var a=t.footerData,i=e.footerFilterMethod?a.filter(e.footerFilterMethod):a,c=t.tableColumn.map(function(t){return n.includes(t)});i.forEach(function(t){l+=t.filter(function(t,e){return'"'.concat(c[e],'"')}).join(",")+"\n"})}return l}function toHtml(t,e,n,o){var r=e.original,l='<table border="1" cellspacing="0" cellpadding="0">';if(e.isHeader&&(l+="<thead><tr><th>"+n.map(function(t){var e=t.own;return _tools.UtilTools.getFuncText(e.title||e.label)}).join("</th><th>")+"</th></tr></thead>"),l+="<tbody>",o.forEach(function(e,o){l+="<tr>",l+=r?"<td>"+n.map(function(t){return"index"===t.type?"".concat(t.indexMethod?t.indexMethod(o):o+1):"".concat(_tools.UtilTools.getCellValue(e,t)||"")}).join("</td><td>")+"</td>":"<td>"+n.map(function(t){return"".concat(e[t.id])}).join("</td><td>")+"</td>",l+="</tr>"}),l+="</tbody>",e.isFooter){var a=t.footerData,i=e.footerFilterMethod?a.filter(e.footerFilterMethod):a,c=t.tableColumn.map(function(t){return n.includes(t)});i.length&&(l+="<tfoot>",i.forEach(function(t){l+="<tr><td>"+t.filter(function(t,e){return c[e]}).join("</td><td>")+"</td></tr>"}),l+="</tfoot>")}return l+"</table>"}function downloadFile(t,e){var o=t.filename,n=t.type,r=t.download,l="".concat(o,".").concat(n);if(!r)return Promise.resolve(e);if(navigator.msSaveBlob&&window.Blob)navigator.msSaveBlob(new Blob([e],{type:"text/".concat(n)}),l);else if(_tools.DomTools.browse["-ms"]){var a=window.top.open("about:blank","_blank");a.document.charset="utf-8",a.document.write(e),a.document.close(),a.document.execCommand("SaveAs",l),a.close()}else{var i=document.createElement("a");i.target="_blank",i.download=l,i.href=getDownloadUrl(t,e),document.body.appendChild(i),i.click(),document.body.removeChild(i)}}function getLabelData(r,t,e){return e.map(function(o){var n={};return t.forEach(function(t){var e=_tools.DomTools.getCell(r,{row:o,column:t});n[t.id]=e?e.innerText.trim():""}),n})}function getExportData(t,e,o,n){var r=e.columns?e.columns:n,l=e.data||o;return e.columnFilterMethod&&(r=r.filter(e.columnFilterMethod)),e.dataFilterMethod&&(l=l.filter(e.dataFilterMethod)),{columns:r,datas:e.original?l:getLabelData(t,r,l)}}function getDownloadUrl(t,e){switch(t.type){case"csv":case"html":return getCsvAndHtmlUrl(t,e)}return""}function getCsvAndHtmlUrl(t,e){var o=t.type;return window.Blob&&window.URL&&window.URL.createObjectURL&&!_tools.DomTools.browse.safari?URL.createObjectURL(new Blob([e],{type:"text/".concat(o)})):"data:attachment/".concat(o,";charset=utf-8,").concat(encodeURIComponent(e))}var _default={methods:{_exportCsv:function(t){return this._exportData(t)},_exportData:function(t){var e=this.visibleColumn,o=this.scrollXLoad,n=this.scrollYLoad,r=this.treeConfig,l=Object.assign({filename:"",original:!!r,isHeader:!0,isFooter:!0,download:!0,type:"",data:null,columns:null,columnFilterMethod:null,dataFilterMethod:null,footerFilterMethod:null},t);l.filename||(l.filename="table"),["csv","html"].includes(l.type)||(l.type="csv"),l.original||(o||n)&&(l.original=!0,_tools.UtilTools.warn("vxe.error.scrollOriginal")),t&&t.columns||(l.columnFilterMethod=function(t){return t.property&&-1===["index","checkbox","selection","radio"].indexOf(t.type)});var a=e,i=this.tableFullData;return r&&(i=_xeUtils.default.toTreeArray(i,r)),downloadFile(l,getContent(this,l,a,i))}}};exports.default=_default;