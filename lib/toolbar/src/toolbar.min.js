"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _xeUtils=_interopRequireDefault(require("xe-utils")),_conf=_interopRequireDefault(require("../../conf")),_tools=require("../../tools");function _interopRequireDefault(t){return t&&t.__esModule?t:{default:t}}function _defineProperty(t,e,i){return e in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}var _default2={name:"VxeToolbar",props:{id:String,setting:{type:[Boolean,Object],default:function(){return _conf.default.toolbar.setting}},buttons:{type:Array,default:function(){return _conf.default.toolbar.buttons}},size:String,data:Array,customs:Array},inject:{$grid:{default:null}},data:function(){return{tableCustoms:[],settingStore:{visible:!1}}},computed:{$table:function(){var t=this.$parent,i=this.data,e=t.$children,n=e.indexOf(this);return e.find(function(t,e){return t&&t.refreshColumn&&n<e&&(i?t.data===i:"vxe-table"===t.$vnode.componentOptions.tag)})},vSize:function(){return this.size||this.$parent.size||this.$parent.vSize},isStorage:function(){return this.setting&&this.setting.storage},storageKey:function(){return _conf.default.toolbar.storageKey||"VXE_TABLE_CUSTOM_HIDDEN"}},created:function(){var t=this,e=this.isStorage,i=this.id,n=this.customs,o=this.setting;if(n&&(this.tableCustoms=n),e&&!i)throw new Error("[vxe-table] Toolbar must have a unique primary id.");o&&this.$nextTick(function(){return t.loadStorage()}),_tools.GlobalEvent.on(this,"mousedown",this.handleGlobalMousedownEvent),_tools.GlobalEvent.on(this,"blur",this.handleGlobalBlurEvent)},destroyed:function(){_tools.GlobalEvent.off(this,"mousedown"),_tools.GlobalEvent.off(this,"blur")},render:function(t){var i=this,e=this.$slots,n=this.settingStore,o=this.setting,s=this.buttons,r=void 0===s?[]:s,a=this.vSize,l=this.tableCustoms,u={},c={};return o&&("manual"===o.trigger||("hover"===o.trigger?(u.mouseenter=this.handleMouseenterSettingEvent,u.mouseleave=this.handleMouseleaveSettingEvent,c.mouseenter=this.handleWrapperMouseenterEvent,c.mouseleave=this.handleWrapperMouseleaveEvent):u.click=this.handleClickSettingEvent)),t("div",{class:["vxe-toolbar",_defineProperty({},"size--".concat(a),a)]},[t("div",{class:"vxe-button--wrapper"},e.buttons?e.buttons:r.map(function(e){return t("vxe-button",{on:{click:function(t){return i.btnEvent(e,t)}}},_xeUtils.default.isFunction(e.name)?e.name():e.name)})),o?t("div",{class:["vxe-custom--wrapper",{"is--active":n.visible}],ref:"customWrapper"},[t("div",{class:"vxe-custom--setting-btn",on:u},[t("i",{class:"vxe-icon--menu"})]),t("div",{class:"vxe-custom--option-wrapper"},[t("div",{class:"vxe-custom--option",on:c},l.map(function(e){return e.property&&e.label?t("vxe-checkbox",{props:{value:e.visible},on:{change:function(t){e.visible=t,o&&o.immediate&&i.updateSetting()}}},e.label):null}))])]):null])},methods:{openSetting:function(){this.settingStore.visible=!0},closeSetting:function(){var t=this.setting,e=this.settingStore;e.visible&&(e.visible=!1,t&&!t.immediate&&this.updateSetting())},loadStorage:function(){if(this.isStorage){var t=this.getStorageMap()[this.id];t?this.updateCustoms(t.split(",").map(function(t){return{prop:t,visible:!1}})):this.updateCustoms(this.tableCustoms)}else this.updateCustoms(this.tableCustoms)},updateCustoms:function(t){var e=this,i=this.$grid,n=this.$table,o=i||n;o&&o.reloadCustoms(t).then(function(t){e.tableCustoms=t})},getStorageMap:function(){var t=_conf.default.version,e=_xeUtils.default.toStringJSON(localStorage.getItem(this.storageKey));return e&&e._v===t?e:{_v:t}},saveStorageMap:function(){var t=this.id,e=this.tableCustoms,i=this.isStorage,n=this.storageKey;if(i){var o=this.getStorageMap();o[t]=e.filter(function(t){return!t.visible}).map(function(t){return t.property}).join(",")||void 0,localStorage.setItem(n,_xeUtils.default.toJSONString(o))}return this.$nextTick()},hideColumn:function(t){return t.visible=!1,this.updateSetting()},showColumn:function(t){var e=this.tableCustoms;return t?t.visible=!0:e.forEach(function(t){t.visible=!0}),this.updateSetting()},updateSetting:function(){var t=this.$grid,e=this.$table;if(t||e)return(t||e).refreshColumn(),this.saveStorageMap();throw new Error("[vxe-toolbar] Not found vxe-table.")},handleGlobalMousedownEvent:function(t){_tools.DomTools.getEventTargetNode(t,this.$refs.customWrapper).flag||this.closeSetting()},handleGlobalBlurEvent:function(t){this.closeSetting()},handleClickSettingEvent:function(t){var e=this.settingStore;e.visible=!e.visible},handleMouseenterSettingEvent:function(t){this.settingStore.activeBtn=!0,this.openSetting()},handleMouseleaveSettingEvent:function(t){var e=this,i=this.settingStore;i.activeBtn=!1,setTimeout(function(){i.activeBtn||i.activeWrapper||e.closeSetting()},300)},handleWrapperMouseenterEvent:function(t){this.settingStore.activeWrapper=!0,this.openSetting()},handleWrapperMouseleaveEvent:function(t){var e=this,i=this.settingStore;i.activeWrapper=!1,setTimeout(function(){i.activeBtn||i.activeWrapper||e.closeSetting()},300)},btnEvent:function(t,e){var i=this.$grid;if(i){switch(t.code){case"insert":i.insert();break;case"insert_actived":i.insert().then(function(t){var e=t.row;return i.setActiveRow(e)});break;case"mark_cancel":i.triggerPendingEvent(e);break;case"delete_selection":this.handleDeleteRow(i,"vxe.grid.deleteSelectRecord",function(){return i.commitProxy("delete")});break;case"remove_selection":this.handleDeleteRow(i,"vxe.grid.removeSelectRecord",function(){return i.removeSelecteds()});break;case"save":i.commitProxy("save");break;case"reload":i.commitProxy("reload");break;case"export":i.exportCsv()}_tools.UtilTools.emitEvent(i,"toolbar-button-click",[{button:t,$grid:i},e])}},handleDeleteRow:function(t,e,i){var n=t.getSelectRecords();t.isAlert?n.length?this.$XMsg.confirm(_conf.default.i18n(e)).then(i).catch(function(t){return t}):this.$XMsg.alert(_conf.default.i18n("vxe.grid.selectOneRecord")).catch(function(t){return t}):n.length&&i()}}};exports.default=_default2;