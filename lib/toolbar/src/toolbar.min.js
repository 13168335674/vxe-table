"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _xeUtils=_interopRequireDefault(require("xe-utils/methods/xe-utils")),_conf=_interopRequireDefault(require("../../conf")),_tools=require("../../tools"),_vXETable=require("../../v-x-e-table");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _defineProperty(e,t,o){return t in e?Object.defineProperty(e,t,{value:o,enumerable:!0,configurable:!0,writable:!0}):e[t]=o,e}var _default2={name:"VxeToolbar",props:{id:String,loading:!1,resizable:{type:[Boolean,Object],default:function(){return _conf.default.toolbar.resizable}},refresh:{type:[Boolean,Object],default:function(){return _conf.default.toolbar.refresh}},export:{type:[Boolean,Object],default:function(){return _conf.default.toolbar.export}},setting:{type:[Boolean,Object],default:function(){return _conf.default.toolbar.setting}},buttons:{type:Array,default:function(){return _conf.default.toolbar.buttons}},size:String,data:Array,customs:Array},inject:{$grid:{default:null}},data:function(){return{$table:null,isRefresh:!1,tableFullColumn:[],exportTypes:["csv","html"],exportModes:[{value:"all",label:"vxe.toolbar.expAll"},{value:"selected",label:"vxe.toolbar.expSelected"}],exportStore:{name:"",mode:""},exportOpts:{filename:"",type:"",original:!1,isHeader:!1,isFooter:!1},settingStore:{visible:!1}}},computed:{vSize:function(){return this.size||this.$parent.size||this.$parent.vSize},refreshOpts:function(){return Object.assign({},_conf.default.toolbar.refresh,this.refresh)},expsOpts:function(){return Object.assign({},_conf.default.toolbar.export,this.export)},resizableOpts:function(){return Object.assign({storageKey:"VXE_TABLE_CUSTOM_COLUMN_WIDTH"},_conf.default.toolbar.resizable,this.resizable)},settingOpts:function(){return Object.assign({storageKey:"VXE_TABLE_CUSTOM_COLUMN_HIDDEN"},_conf.default.toolbar.setting,this.setting)}},created:function(){var e=this,t=this.settingOpts,o=this.id,i=this.customs;if(i&&(this.tableFullColumn=i),t.storage&&!o)return _tools.UtilTools.error("vxe.error.toolbarId");this.$nextTick(function(){e.updateConf(),e.loadStorage()}),_tools.GlobalEvent.on(this,"mousedown",this.handleGlobalMousedownEvent),_tools.GlobalEvent.on(this,"blur",this.handleGlobalBlurEvent)},destroyed:function(){_tools.GlobalEvent.off(this,"mousedown"),_tools.GlobalEvent.off(this,"blur")},render:function(l){var e,r=this,o=this._e,t=this.$scopedSlots,i=this.$grid,n=this.$table,s=this.loading,a=this.settingStore,u=this.refresh,c=this.setting,d=this.settingOpts,f=this.buttons,h=void 0===f?[]:f,p=this.vSize,v=this.tableFullColumn,b={},g={},x=t.buttons,m=t.tools;return c&&("manual"===d.trigger||("hover"===d.trigger?(b.mouseenter=this.handleMouseenterSettingEvent,b.mouseleave=this.handleMouseleaveSettingEvent,g.mouseenter=this.handleWrapperMouseenterEvent,g.mouseleave=this.handleWrapperMouseleaveEvent):b.click=this.handleClickSettingEvent)),l("div",{class:["vxe-toolbar",(e={},_defineProperty(e,"size--".concat(p),p),_defineProperty(e,"is--loading",s),e)]},[l("div",{class:"vxe-button--wrapper"},x?x.call(this,{$grid:i,$table:n},l):h.map(function(t){return!1===t.visible?o():l("vxe-button",{on:{click:function(e){return r.btnEvent(e,t)}},props:{disabled:t.disabled},scopedSlots:t.dropdowns&&t.dropdowns.length?{default:function(){return _tools.UtilTools.getFuncText(t.name)},dropdowns:function(){return t.dropdowns.map(function(t){return!1===t.visible?o():l("vxe-button",{on:{click:function(e){return r.btnEvent(e,t)}},props:{disabled:t.disabled}},_tools.UtilTools.getFuncText(t.name))})}}:null},_tools.UtilTools.getFuncText(t.name))})),l("div",{class:"vxe-tools--operate"},[this.export?l("vxe-button",{class:"vxe-export--btn",props:{type:"text",icon:_conf.default.icon.export},on:{click:this.exportEvent}}):null,u?l("vxe-button",{class:"vxe-refresh--btn",props:{type:"text",icon:_conf.default.icon.refresh,loading:this.isRefresh},on:{click:this.refreshEvent}}):null,c?l("div",{class:["vxe-custom--wrapper",{"is--active":a.visible}],ref:"customWrapper"},[l("div",{class:"vxe-custom--setting-btn",on:b},[l("i",{class:_conf.default.icon.custom})]),l("div",{class:"vxe-custom--option-wrapper"},[l("div",{class:"vxe-custom--option",on:g},v.map(function(t){var e=t.property,o=t.visible,i=t.own,n=_tools.UtilTools.getFuncText(i.title||i.label);return e&&n?l("vxe-checkbox",{props:{value:o},attrs:{title:n},on:{change:function(e){t.visible=e,c&&d.immediate&&r.updateSetting()}}},n):null}))])]):null]),m?l("div",{class:"vxe-tools--wrapper"},m.call(this,{$grid:i,$table:n},l)):null])},methods:{updateConf:function(){var e=this.$parent,o=this.data,t=e.$children,i=t.indexOf(this);this.$table=t.find(function(e,t){return e&&e.refreshColumn&&i<t&&(o?e.data===o:"vxe-table"===e.$vnode.componentOptions.tag)})},openSetting:function(){this.settingStore.visible=!0},closeSetting:function(){var e=this.setting,t=this.settingStore;t.visible&&(t.visible=!1,e&&!t.immediate&&this.updateSetting())},loadStorage:function(){var e=this.$grid,t=this.$table,o=this.id,i=this.refresh,n=this.resizable,l=this.setting,r=this.refreshOpts,s=this.resizableOpts,a=this.settingOpts;if(i&&!e&&(r.query||_tools.UtilTools.warn("vxe.error.notFunc",["query"])),n||l){if(!e&&!t)throw new Error(_tools.UtilTools.getLog("vxe.error.barUnableLink"));(e||t).connect({toolbar:this});var u={};if(s.storage){var c=this.getStorageMap(s.storageKey)[o];c&&_xeUtils.default.each(c,function(e,t){u[t]={field:t,resizeWidth:e}})}if(a.storage){var d=this.getStorageMap(a.storageKey)[o];d&&d.split(",").forEach(function(e){u[e]?u[e].visible=!1:u[e]={field:e,visible:!1}})}var f=Object.values(u);this.updateCustoms(f.length?f:this.tableFullColumn)}},updateColumn:function(e){this.tableFullColumn=e},updateCustoms:function(e){var t=this,o=this.$grid,i=this.$table,n=o||i;n&&n.reloadCustoms(e).then(function(e){t.tableFullColumn=e})},getStorageMap:function(e){var t=_conf.default.version,o=_xeUtils.default.toStringJSON(localStorage.getItem(e));return o&&o._v===t?o:{_v:t}},saveColumnHide:function(){var e=this.id,t=this.tableFullColumn,o=this.settingOpts;if(o.storage){var i=this.getStorageMap(o.storageKey),n=t.filter(function(e){return e.property&&!e.visible});i[e]=n.length?n.map(function(e){return e.property}).join(","):void 0,localStorage.setItem(o.storageKey,_xeUtils.default.toJSONString(i))}return this.$nextTick()},saveColumnWidth:function(e){var t=this.id,o=this.tableFullColumn,i=this.resizableOpts;if(i.storage){var n,l=this.getStorageMap(i.storageKey);e||(n=_xeUtils.default.isPlainObject(l[t])?l[t]:{},o.forEach(function(e){var t=e.property,o=e.resizeWidth,i=e.renderWidth;t&&o&&(n[t]=i)})),l[t]=_xeUtils.default.isEmpty(n)?void 0:n,localStorage.setItem(i.storageKey,_xeUtils.default.toJSONString(l))}return this.$nextTick()},hideColumn:function(e){return _tools.UtilTools.warn("vxe.error.delFunc",["hideColumn","table.hideColumn"]),e.visible=!1,this.updateSetting()},showColumn:function(e){return _tools.UtilTools.warn("vxe.error.delFunc",["showColumn","table.showColumn"]),e.visible=!0,this.updateSetting()},resetCustoms:function(){return this.updateSetting()},resetResizable:function(){this.updateResizable(this)},updateResizable:function(e){var t=this.$grid,o=this.$table,i=t||o;return this.saveColumnWidth(e),i.analyColumnWidth(),i.recalculate(!0)},updateSetting:function(){return(this.$grid||this.$table).refreshColumn(),this.saveColumnHide()},handleGlobalMousedownEvent:function(e){_tools.DomTools.getEventTargetNode(e,this.$refs.customWrapper).flag||this.closeSetting()},handleGlobalBlurEvent:function(e){this.closeSetting()},handleClickSettingEvent:function(e){var t=this.settingStore;t.visible=!t.visible},handleMouseenterSettingEvent:function(e){this.settingStore.activeBtn=!0,this.openSetting()},handleMouseleaveSettingEvent:function(e){var t=this,o=this.settingStore;o.activeBtn=!1,setTimeout(function(){o.activeBtn||o.activeWrapper||t.closeSetting()},300)},handleWrapperMouseenterEvent:function(e){this.settingStore.activeWrapper=!0,this.openSetting()},handleWrapperMouseleaveEvent:function(e){var t=this,o=this.settingStore;o.activeWrapper=!1,setTimeout(function(){o.activeBtn||o.activeWrapper||t.closeSetting()},300)},refreshEvent:function(){var e=this,t=this.$grid,o=this.refreshOpts;this.isRefresh||(o.query?(this.isRefresh=!0,o.query().catch(function(e){return e}).then(function(){e.isRefresh=!1})):t&&(this.isRefresh=!0,t.commitProxy("reload").catch(function(e){return e}).then(function(){e.isRefresh=!1})))},btnEvent:function(e,t){var o=this.$grid,i=this.$table,n=t.code;if(n)if(o)o.triggerToolbarBtnEvent(t,e);else{var l=_vXETable.Buttons.get(n),r={code:n,button:t,$grid:o,$table:i};l&&l.call(this,r,e),_tools.UtilTools.emitEvent(this,"button-click",[r,e])}},exportEvent:function(){var e=this.$grid,t=this.$table,o=this.vSize,i=this.exportStore,l=this.exportOpts,r=this.exportTypes,s=this.exportModes,a=e||t,n=a.getTableColumn().fullColumn,u=a.getTableData().footerData,c=a.getSelectRecords(),d=a.getVirtualScroller(),f=n.filter(function(e){return"index"===e.type||e.property&&-1===["checkbox","selection","radio"].indexOf(e.type)}),h=!!a.getTreeStatus()||d.scrollX||d.scrollY,p=!!u.length;i.mode=c.length?"selected":"all",Object.assign(l,{filename:"",type:"csv",original:h,isHeader:!0,isFooter:p}),f.forEach(function(e){e.checked="index"!==e.type}),this.$XModal({title:_conf.default.i18n("vxe.toolbar.expTitle"),width:520,mask:!0,lockView:!0,showFooter:!1,maskClosable:!0,size:o,slots:{default:function(e,n){var t=e.$modal;return[n("div",{class:"vxe-export--panel"},[n("table",{attrs:{cellspacing:0,cellpadding:0,border:0}},[n("tr",[n("td",_conf.default.i18n("vxe.toolbar.expName")),n("td",[n("input",{ref:"filename",attrs:{type:"text",placeholder:_conf.default.i18n("vxe.toolbar.expNamePlaceholder")},domProps:{value:l.filename},on:{input:function(e){l.filename=e.target.value}}})])]),n("tr",[n("td",_conf.default.i18n("vxe.toolbar.expType")),n("td",[n("select",{on:{change:function(e){l.type=e.target.value}}},r.map(function(e){return n("option",{attrs:{value:e},domProps:{selected:l.type===e}},e)}))])]),n("tr",[n("td",_conf.default.i18n("vxe.toolbar.expMode")),n("td",[n("select",{on:{change:function(e){i.mode=e.target.value}}},s.map(function(e){return n("option",{attrs:{value:e.value},domProps:{selected:i.mode===e.value}},_conf.default.i18n(e.label))}))])]),n("tr",[n("td",_conf.default.i18n("vxe.toolbar.expColumn")),n("td",[n("ul",{class:"vxe-export--panel-column"},f.map(function(e){var t=e.own,o=e.checked,i=e.type;return n("li",{class:{active:o},on:{click:function(){e.checked=!o}}},_tools.UtilTools.getFuncText(t.title||t.label||("index"===i?_conf.default.i18n("vxe.column.indexTitle"):"")))}))])]),n("tr",[n("td",_conf.default.i18n("vxe.toolbar.expOpts")),n("td",[n("vxe-checkbox",{props:{size:o},model:{value:l.isHeader,callback:function(e){l.isHeader=e}}},_conf.default.i18n("vxe.toolbar.expOptHeader")),n("vxe-checkbox",{props:{size:o,disabled:!p},model:{value:l.isFooter,callback:function(e){l.isFooter=e}}},_conf.default.i18n("vxe.toolbar.expOptFooter")),n("vxe-checkbox",{props:{size:o,disabled:h},model:{value:l.original,callback:function(e){l.original=e}}},_conf.default.i18n("vxe.toolbar.expOptOriginal"))])])]),n("div",{class:"vxe-export--panel-btns"},[n("vxe-button",{props:{type:"primary",size:o},on:{click:function(){var e=Object.assign({columns:f.filter(function(e){return e.checked})},l);e.filename||(e.filename=_conf.default.i18n("vxe.toolbar.expTitle")),"selected"===i.mode&&(e.data=c),a.exportData(e),t.close()}}},_conf.default.i18n("vxe.toolbar.expConfirm"))])])]}},events:{show:function(e){e.$modal.$refs.filename.focus()}}})}}};exports.default=_default2;